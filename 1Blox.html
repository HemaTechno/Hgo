<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>المهام</title>
</head>
<body>

<h2>اختار المهمة</h2>

<button onclick="completeTask('task1')">المهمة الأولى</button>
<br><br>
<button onclick="completeTask('task2')">المهمة الثانية</button>
<br><br>
<button onclick="completeTask('task3')">المهمة الثالثة</button>
<br><br>

<button onclick="getScript()">الحصول على السكربت</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
  authDomain: "hhhhhh-d4fb8.firebaseapp.com",
  databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
  projectId: "hhhhhh-d4fb8",
  storageBucket: "hhhhhh-d4fb8.appspot.com",
  messagingSenderId: "24512338206",
  appId: "1:24512338206:web:dfe045db59bd3434a2110f",
  measurementId: "G-HD4R7GNQ5H"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase();

let userIP = "";

// روابط كل مهمة
const taskLinks = {
  task1: "https://example.com/task1",
  task2: "https://example.com/task2",
  task3: "https://example.com/task3"
};

// الحصول على IP
fetch("https://api.ipify.org?format=json")
  .then(r => r.json())
  .then(data => {
    userIP = data.ip;
    set(ref(db, "users/" + userIP), { lastTask: "none" });
  });

// حفظ المهمة + فتح الرابط
function completeTask(taskName) {
  set(ref(db, "users/" + userIP), { lastTask: taskName });

  // فتح رابط المهمة
  window.open(taskLinks[taskName], "_blank");

  // يروح صفحة التحقق بعد كدا
  setTimeout(() => {
    window.location.href = "check.html";
  }, 1000);
}

// زر الحصول على السكربت
function getScript() {
  get(ref(db, "users/" + userIP)).then(snapshot => {
    if (!snapshot.exists() || snapshot.val().lastTask !== "task3") {
      alert("يجب إنهاء كل المهام أولاً!");
      return;
    }

    // مسح الداتا
    set(ref(db, "users/" + userIP), null);

    // فتح صفحة السكربت
    window.open("https://your-script-page.com", "_blank");
  });
}
</script>

</body>
</html>
