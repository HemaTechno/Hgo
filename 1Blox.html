<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>المهام</title>
</head>
<body>

<h2>اختار المهمة</h2>

<button onclick="completeTask('task1')">المهمة الأولى</button>
<br><br>
<button onclick="completeTask('task2')">المهمة الثانية</button>
<br><br>
<button onclick="completeTask('task3')">المهمة الثالثة</button>
<br><br>

<button onclick="getScript()">الحصول على السكربت</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

// -------------------------
// Firebase Config (اللي بعتهالي)
// -------------------------
const firebaseConfig = {
  apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
  authDomain: "hhhhhh-d4fb8.firebaseapp.com",
  databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
  projectId: "hhhhhh-d4fb8",
  storageBucket: "hhhhhh-d4fb8.appspot.com",
  messagingSenderId: "24512338206",
  appId: "1:24512338206:web:dfe045db59bd3434a2110f",
  measurementId: "G-HD4R7GNQ5H"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// -------------------------
// روابط المهمات
// -------------------------
const taskLinks = {
  task1: "https://example.com/task1",
  task2: "https://example.com/task2",
  task3: "https://example.com/task3"
};

// -------------------------
// جلب عنوان IP
// -------------------------
let userIP = "";

fetch("https://ipapi.co/json/")
  .then(r => r.json())
  .then(data => {
    userIP = data.ip;

    // إنشاء سجل للمستخدم لو مش موجود
    set(ref(db, "users/" + userIP), {
      lastTask: "none"
    });
  })
  .catch(err => {
    console.error("IP Error:", err);
    alert("خطأ في الحصول على الـ IP");
  });

// -------------------------
// عند الضغط على أي مهمة
// -------------------------
function completeTask(taskName) {

  if (!userIP) {
    alert("جاري الحصول على IP...");
    return;
  }

  // حفظ المهمة في Firebase
  set(ref(db, "users/" + userIP), { lastTask: taskName });

  // فتح رابط المهمة
  window.open(taskLinks[taskName], "_blank");

  // بعد ثانية يروح صفحة check
  setTimeout(() => {
    window.location.href = "check.html";
  }, 1000);
}

// -------------------------
// زر الحصول على السكربت
// -------------------------
function getScript() {

  get(ref(db, "users/" + userIP)).then(snapshot => {

    if (!snapshot.exists() || snapshot.val().lastTask !== "task3") {
      alert("لازم تكمل كل المهام الأول!");
      return;
    }

    // مسح الداتا بعد ما ياخد السكربت
    set(ref(db, "users/" + userIP), null);

    // افتح صفحة السكربت
    window.open("https://your-script-page.com", "_blank");

  });

}
</script>

</body>
</html>

