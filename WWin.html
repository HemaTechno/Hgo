<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>🎡 عجلة الحظ الفخمة</title>
  
  <!-- مكتبة GSAP للرسوم المتحركة المتقدمة -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  
  <script type="module">
    // ------------------ Firebase إعداد ------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f",
      measurementId: "G-HD4R7GNQ5H"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // ------------------ عناصر الصفحة ------------------
    const canvas = document.createElement("canvas");
    canvas.id = "wheel";
    canvas.width = 500;
    canvas.height = 500;
    document.body.querySelector("#wheelContainer").appendChild(canvas);

    const ctx = canvas.getContext("2d");
    const namesListDiv = document.getElementById("namesList");
    const countSpan = document.getElementById("count");
    const startBtn = document.getElementById("startBtn");
    const winnersDiv = document.getElementById("winners");
    const winnerCountInput = document.getElementById("winnerCount");
    const confettiContainer = document.getElementById("confettiContainer");

    let participants = [];
    let anglePerSlice = 0;
    let rotation = 0;
    let isSpinning = false;

    // الألوان للعجلة
    const wheelColors = [
      "#FF6B6B", "#4ECDC4", "#45B7D1", "#FFA07A", 
      "#98D8C8", "#F7DC6F", "#BB8FCE", "#85C1E9",
      "#F8C471", "#82E0AA", "#F1948A", "#85C1E9",
      "#D7BDE2", "#F9E79F", "#A9DFBF", "#F5B7B1"
    ];

    // تأثيرات صوتية
    const spinSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3");
    const winSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3");
    const tickSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3");

    // رسم العجلة المحسنة
    function drawWheel() {
      ctx.clearRect(0, 0, 500, 500);
      const num = participants.length;
      if (num === 0) return;
      anglePerSlice = (2 * Math.PI) / num;
      
      // رسم العجلة الخارجية
      ctx.beginPath();
      ctx.arc(250, 250, 250, 0, 2 * Math.PI);
      ctx.fillStyle = "#1a1a2e";
      ctx.fill();
      ctx.strokeStyle = "#ffcc00";
      ctx.lineWidth = 5;
      ctx.stroke();
      
      // رسم الشرائح
      for (let i = 0; i < num; i++) {
        const angle = i * anglePerSlice;
        ctx.beginPath();
        ctx.moveTo(250, 250);
        ctx.arc(250, 250, 245, angle, angle + anglePerSlice);
        ctx.fillStyle = wheelColors[i % wheelColors.length];
        ctx.fill();
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 1;
        ctx.stroke();
        
        // إضافة تأثير ثلاثي الأبعاد
        ctx.beginPath();
        ctx.arc(250, 250, 245, angle, angle + anglePerSlice);
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.lineWidth = 3;
        ctx.stroke();
        
        // كتابة الأسماء
        ctx.save();
        ctx.translate(250, 250);
        ctx.rotate(angle + anglePerSlice / 2);
        ctx.fillStyle = "#fff";
        ctx.font = "bold 18px Cairo";
        ctx.textAlign = "right";
        const name = participants[i].length > 10 ? participants[i].substring(0, 10) + "…" : participants[i];
        ctx.fillText(name, 180, 5);
        ctx.restore();
      }
      
      // رسم المركز
      ctx.beginPath();
      ctx.arc(250, 250, 30, 0, 2 * Math.PI);
      ctx.fillStyle = "#ffcc00";
      ctx.fill();
      ctx.strokeStyle = "#fff";
      ctx.lineWidth = 3;
      ctx.stroke();
      
      // إضافة تأثير لامع في المركز
      const gradient = ctx.createRadialGradient(250, 250, 10, 250, 250, 30);
      gradient.addColorStop(0, "#fff");
      gradient.addColorStop(1, "#ffcc00");
      ctx.fillStyle = gradient;
      ctx.fill();
    }

    // تأثير الكونفيتي
    function createConfetti() {
      const confettiCount = 200;
      const colors = ['#f00', '#0f0', '#00f', '#ff0', '#f0f', '#0ff'];
      
      for (let i = 0; i < confettiCount; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.animationDelay = Math.random() * 5 + 's';
        confettiContainer.appendChild(confetti);
        
        // إزالة الكونفيتي بعد انتهاء الحركة
        setTimeout(() => {
          confetti.remove();
        }, 5000);
      }
    }

    // 🔥 جلب الأسماء من المسار "users"
    const usersRef = ref(db, "users");
    onValue(usersRef, (snapshot) => {
      participants = [];
      namesListDiv.innerHTML = "";
      snapshot.forEach((child) => {
        const data = child.val();
        if (data.name) {
          participants.push(data.name);
          const nameDiv = document.createElement("div");
          nameDiv.className = "name-item";
          nameDiv.textContent = data.name;
          namesListDiv.appendChild(nameDiv);
        }
      });
      countSpan.textContent = participants.length;
      if (participants.length === 0) namesListDiv.innerHTML = "لا يوجد مشاركين بعد.";
      drawWheel();
    });

    // تشغيل العجلة مع تحسينات الرسوم المتحركة
    startBtn.onclick = () => {
      if (participants.length === 0) return alert("لا يوجد أسماء في السحب!");
      const count = parseInt(winnerCountInput.value);
      if (isNaN(count) || count < 1) return alert("عدد الفائزين غير صحيح!");
      if (count > participants.length) return alert("عدد الفائزين أكبر من عدد الأسماء!");
      if (isSpinning) return;

      isSpinning = true;
      winnersDiv.innerHTML = "";
      startBtn.disabled = true;

      let winners = [];
      let remaining = [...participants];

      function spinOneWinner(i) {
        // تشغيل صوت الدوران
        spinSound.play();
        
        // إضافة تأثير اهتزاز للزر
        gsap.to(startBtn, {
          x: 5, duration: 0.1, yoyo: true, repeat: 5,
          onComplete: () => gsap.set(startBtn, {x: 0})
        });

        const randomIndex = Math.floor(Math.random() * remaining.length);
        const winner = remaining[randomIndex];
        remaining.splice(randomIndex, 1);

        // حساب الدوران مع تأثير الإبطاء
        const targetRotation = rotation + 360 * 5 + (360 / participants.length) * randomIndex;
        
        gsap.to(canvas, {
          rotation: targetRotation,
          duration: 5,
          ease: "power2.out",
          onUpdate: function() {
            // تشغيل صوت النقر أثناء الدوران
            if (Math.random() < 0.1) {
              tickSound.currentTime = 0;
              tickSound.play();
            }
          },
          onComplete: function() {
            // تشغيل صوت الفوز
            winSound.play();
            
            // إضافة تأثير الكونفيتي
            createConfetti();
            
            // إظهار الفائز بتأثير متدرج
            winners.push(winner);
            const winnerElement = document.createElement("div");
            winnerElement.className = "winner-item";
            winnerElement.innerHTML = `
              <div class="winner-card">
                <div class="winner-crown">👑</div>
                <h2>🎉 الفائز رقم ${i + 1}</h2>
                <div class="winner-name">${winner}</div>
                <div class="winner-celebration">مبروك!</div>
              </div>
            `;
            winnersDiv.appendChild(winnerElement);
            
            // تأثير ظهور الفائز
            gsap.from(winnerElement, {
              y: 50,
              opacity: 0,
              duration: 1,
              ease: "back.out(1.7)"
            });
            
            if (i + 1 < count) {
              setTimeout(() => spinOneWinner(i + 1), 3000);
            } else {
              isSpinning = false;
              startBtn.disabled = false;
            }
          }
        });
        
        rotation = targetRotation;
      }

      spinOneWinner(0);
    };
  </script>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: radial-gradient(circle at center, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      font-family: "Cairo", sans-serif;
      color: #fff;
      text-align: center;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    h1 {
      margin: 20px 0;
      color: #ffcc00;
      font-size: 42px;
      text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
      position: relative;
    }
    
    h1::after {
      content: "";
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 3px;
      background: linear-gradient(90deg, transparent, #ffcc00, transparent);
    }
    
    .stats {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 15px 25px;
      margin: 15px 0;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
    }
    
    #count {
      color: #4ECDC4;
      font-weight: bold;
      font-size: 24px;
    }
    
    #wheelContainer {
      margin: 30px auto;
      position: relative;
      width: 500px;
      height: 500px;
      filter: drop-shadow(0 0 20px rgba(255, 204, 0, 0.3));
    }
    
    #pointer {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 25px solid transparent;
      border-right: 25px solid transparent;
      border-bottom: 50px solid #ff3b3b;
      filter: drop-shadow(0 5px 5px rgba(0, 0, 0, 0.5));
      z-index: 10;
    }
    
    #pointer::after {
      content: "";
      position: absolute;
      top: 10px;
      left: -10px;
      width: 20px;
      height: 20px;
      background: #ff3b3b;
      border-radius: 50%;
    }
    
    .controls {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      width: 100%;
      max-width: 500px;
    }
    
    .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    label {
      font-size: 18px;
    }
    
    input {
      padding: 10px 15px;
      border-radius: 10px;
      border: 2px solid #4ECDC4;
      font-size: 18px;
      text-align: center;
      background: rgba(255, 255, 255, 0.9);
      width: 80px;
    }
    
    button {
      background: linear-gradient(90deg, #ff3b3b, #ff5555);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 22px;
      cursor: pointer;
      transition: 0.3s;
      margin-top: 10px;
      box-shadow: 0 5px 15px rgba(255, 59, 59, 0.4);
      font-weight: bold;
      position: relative;
      overflow: hidden;
    }
    
    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(255, 59, 59, 0.6);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button:disabled {
      background: linear-gradient(90deg, #666, #888);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    button::after {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: rgba(255, 255, 255, 0.1);
      transform: rotate(45deg);
      transition: all 0.5s;
    }
    
    button:hover::after {
      transform: rotate(45deg) translate(50%, 50%);
    }
    
    #namesList {
      background: rgba(255,255,255,0.05);
      border: 2px solid #4ECDC4;
      border-radius: 15px;
      width: 100%;
      max-width: 500px;
      margin: 15px auto;
      max-height: 200px;
      overflow-y: auto;
      padding: 15px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .name-item {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .name-item:hover {
      background: rgba(78, 205, 196, 0.3);
      transform: translateY(-2px);
    }
    
    #winners {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      width: 100%;
    }
    
    .winner-item {
      flex: 1;
      min-width: 250px;
      max-width: 300px;
    }
    
    .winner-card {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
      border: 2px solid #ffcc00;
      position: relative;
      overflow: hidden;
    }
    
    .winner-card::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #ff3b3b, #ffcc00, #4ECDC4);
    }
    
    .winner-crown {
      font-size: 40px;
      margin-bottom: 10px;
      animation: bounce 2s infinite;
    }
    
    .winner-card h2 {
      color: #ffcc00;
      margin-bottom: 10px;
      font-size: 22px;
    }
    
    .winner-name {
      font-size: 24px;
      font-weight: bold;
      color: #4ECDC4;
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    .winner-celebration {
      color: #ff6b6b;
      font-weight: bold;
      font-size: 18px;
      margin-top: 10px;
    }
    
    /* تأثيرات الكونفيتي */
    #confettiContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 100;
    }
    
    .confetti {
      position: absolute;
      width: 10px;
      height: 20px;
      opacity: 0;
      animation: confetti-fall 5s linear forwards;
    }
    
    @keyframes confetti-fall {
      0% {
        transform: translateY(-100px) rotate(0deg);
        opacity: 1;
      }
      100% {
        transform: translateY(100vh) rotate(360deg);
        opacity: 0;
      }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    /* شريط التمرير المخصص */
    #namesList::-webkit-scrollbar {
      width: 8px;
    }
    
    #namesList::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
    }
    
    #namesList::-webkit-scrollbar-thumb {
      background: #4ECDC4;
      border-radius: 10px;
    }
    
    /* تأثيرات الاستجابة */
    @media (max-width: 768px) {
      h1 {
        font-size: 32px;
      }
      
      #wheelContainer {
        width: 350px;
        height: 350px;
      }
      
      canvas {
        width: 350px;
        height: 350px;
      }
      
      .controls, #namesList {
        max-width: 350px;
      }
    }
    
    @media (max-width: 480px) {
      h1 {
        font-size: 28px;
      }
      
      #wheelContainer {
        width: 300px;
        height: 300px;
      }
      
      canvas {
        width: 300px;
        height: 300px;
      }
      
      .controls, #namesList {
        max-width: 300px;
      }
      
      button {
        padding: 12px 30px;
        font-size: 18px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>🎡 عجلة الحظ الفخمة</h1>
    
    <div class="stats">
      <h3>عدد الأسماء المشاركة: <span id="count">0</span></h3>
    </div>
    
    <div id="namesList">جارٍ تحميل الأسماء...</div>
    
    <div class="controls">
      <div class="input-group">
        <input type="number" id="winnerCount" min="1" value="1" />
        <label for="winnerCount">عدد الفائزين</label>
      </div>
      <button id="startBtn">ابدأ السحب 🎡</button>
    </div>
    
    <div id="wheelContainer">
      <div id="pointer"></div>
    </div>
    
    <div id="winners"></div>
  </div>
  
  <div id="confettiContainer"></div>
</body>
</html>


