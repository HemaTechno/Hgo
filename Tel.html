<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini App Coins</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9747739' data-sdk='show_9747739'></script>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">ğŸš€ Mini App</h1>
    <div id="coinsBox" class="bg-blue-600 px-4 py-1 rounded-full">ğŸª™ 0</div>
  </header>

  <!-- Tasks Page -->
  <main id="pageTasks" class="flex-1 p-6 text-center">
    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg space-y-4">
      <h2 class="text-lg">ğŸ¥ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
      <div class="w-full bg-gray-700 rounded-full h-2">
        <div id="progressBar" class="bg-blue-500 h-2 rounded-full w-0"></div>
      </div>
      <p id="taskInfo">0 / 100 Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙŠÙˆÙ…</p>
      <button id="watchAdBtn" class="bg-blue-600 px-4 py-2 rounded-xl">ğŸ¥ Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†</button>
    </div>
  </main>

<script>
  // âœ… Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
    authDomain: "hhhhhh-d4fb8.firebaseapp.com",
    projectId: "hhhhhh-d4fb8"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Telegram User
  const tg = window.Telegram.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id?.toString() || "guest";

  // User Data
  let coins = 0;
  let tasksToday = 0;
  const DAILY_LIMIT = 100;

  // Load User
  async function loadUser() {
    const today = new Date().toISOString().split("T")[0];
    const ref = db.collection("users").doc(userId);
    const docSnap = await ref.get();

    if (!docSnap.exists) {
      await ref.set({ coins: 0, tasksToday: 0, lastTaskDate: today });
    } else {
      const data = docSnap.data();
      coins = data.coins || 0;
      if (data.lastTaskDate !== today) {
        tasksToday = 0;
        await ref.update({ tasksToday: 0, lastTaskDate: today });
      } else {
        tasksToday = data.tasksToday || 0;
      }
    }
    updateUI();
  }

  // Update UI
  function updateUI() {
    document.getElementById("coinsBox").textContent = "ğŸª™ " + coins;
    document.getElementById("taskInfo").textContent = tasksToday + "/" + DAILY_LIMIT + " Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙŠÙˆÙ…";
    document.getElementById("progressBar").style.width = (tasksToday/DAILY_LIMIT*100)+"%";
  }

  // Watch Ad
  document.getElementById("watchAdBtn").addEventListener("click", async () => {
    if (tasksToday >= DAILY_LIMIT) {
      return alert("âŒ ÙˆØµÙ„Øª Ø§Ù„Ø­Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ");
    }

    const btn = document.getElementById("watchAdBtn");
    btn.disabled = true;
    btn.textContent = "â³ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù‚ÙŠØ¯ Ø§Ù„Ø¹Ø±Ø¶...";

    try {
      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
      if (typeof window.show_9747739 === "function") {
        window.show_9747739({
          type: 'inApp',
          inAppSettings: { interval: 5 }
        });
        console.log("ğŸ¥ Ad started");
      } else {
        console.warn("âš ï¸ Monetag SDK not ready");
        alert("Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ø³Ù‡ Ø¨ÙŠØ¬Ù‡Ø².. Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ");
        btn.disabled = false;
        btn.textContent = "ğŸ¥ Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†";
        return;
      }

      // Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ© Ø§Ø¹ØªØ¨Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§ØªØ´Ø§Ù
      setTimeout(async () => {
        coins++;
        tasksToday++;
        await db.collection("users").doc(userId).set({
          coins,
          tasksToday,
          lastTaskDate: new Date().toISOString().split("T")[0]
        }, { merge: true });

        updateUI();
        alert("âœ… Ù…Ø¨Ø±ÙˆÙƒ! ÙƒØ³Ø¨Øª 1 ÙƒÙˆÙŠÙ† Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†");
        btn.disabled = false;
        btn.textContent = "ğŸ¥ Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†";
      }, 30000);

    } catch (err) {
      console.error("âŒ Error:", err);
      btn.disabled = false;
      btn.textContent = "ğŸ¥ Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†";
    }
  });

  loadUser();
</script>

</body>
</html>


