
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† â€” AdsGram x Telegram Mini App</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- AdsGram SDK (vanilla JS) -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151922;
      --text: #e8ebf0;
      --muted: #a8b3c7;
      --accent: #22c55e;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
      display: grid; place-items: center;
    }
    .wrap { width: min(680px, 92vw); }
    .card {
      background: var(--card); border-radius: 20px; padding: 22px; box-shadow: 0 10px 30px rgb(0 0 0 / 30%);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { margin: 0 0 16px; color: var(--muted); line-height: 1.6; }
    .actions { display: flex; gap: 10px; align-items: center; }
    button {
      appearance: none; border: 0; border-radius: 14px; padding: 12px 18px; font-weight: 700; cursor: pointer;
    }
    #watchAdBtn { background: var(--accent); color: #052e13; }
    #watchAdBtn[disabled] { opacity: .6; cursor: not-allowed; }
    .pill { padding: 8px 12px; border-radius: 999px; font-size: 13px; }
    .pill.ok { background: rgb(34 197 94 / 18%); color: #6ee7b7; }
    .pill.err { background: rgb(239 68 68 / 15%); color: #fecaca; }
    .hidden { display: none; }
    a.cta { color: var(--accent); text-decoration: none; font-weight: 700; }
    .footer { margin-top: 14px; font-size: 12px; color: var(--muted); opacity: .8; }
    .grid { display: grid; gap: 12px; }
    .two { grid-template-columns: 1fr 1fr; }
    .stat { background: #0e1220; border-radius: 14px; padding: 12px; }
    .stat h3 { margin: 0 0 6px; font-size: 14px; color: #a8b3c7; font-weight: 600; }
    .stat .v { font-size: 20px; font-weight: 800; }
    .task { display:flex; justify-content: space-between; align-items:center; padding:10px; border-radius:12px; background:#0e1220; }
    .task small { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</h1>
      <p>Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† <strong>AdsGram</strong>. Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.</p>
      <div class="actions">
        <button id="watchAdBtn">â–¶ï¸ Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
        <span id="status" class="pill hidden"></span>
      </div>
      <div id="reward" class="hidden" style="margin-top:14px">
        <p class="pill ok">âœ… ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.</p>
        <!-- Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨Ùƒ -->
        <p><a id="rewardLink" class="cta" href="#" target="_blank" rel="noopener">Ø§ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¢Ù†</a></p>
      </div>
      <div id="errorBox" class="hidden" style="margin-top:14px">
        <p class="pill err">âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.</p>
      </div>
      <div class="footer">Mini App ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. Ù„Ùˆ ÙØªØ­ØªÙ‡ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>

      <hr style="border:0;border-top:1px solid #222; margin:18px 0; opacity:.5">

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="grid two">
        <div class="stat">
          <h3>Ø§Ù„Ø±ØµÙŠØ¯ (Coins)</h3>
          <div class="v" id="coins">0</div>
        </div>
        <div class="stat">
          <h3>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="v"><span id="levelToday">0</span>/20</div>
        </div>
        <div class="stat">
          <h3>Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</h3>
          <div class="v" id="cooldown">Ø¬Ø§Ù‡Ø²</div>
        </div>
        <div class="stat">
          <h3>Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="v" id="tasksToday">0</div>
        </div>
      </div>

      <div style="margin-top:14px" class="grid">
        <button id="claimDailyBtn">ğŸ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
        <span id="dailyStatus" class="pill hidden"></span>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… ØªØ¬Ø±ÙŠØ¨ÙŠØ© -->
      <div style="margin-top:14px" class="grid">
        <div class="task">
          <div>
            <div>Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… 1</div>
            <small>ÙŠÙƒØ³Ø¨ 1 ÙƒÙˆÙŠÙ† â€” ÙŠØªØ·Ù„Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†</small>
          </div>
          <button data-task-id="task1" class="taskBtn">ØªÙ†ÙÙŠØ°</button>
        </div>
        <div class="task">
          <div>
            <div>Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… 2</div>
            <small>ÙŠÙƒØ³Ø¨ 1 ÙƒÙˆÙŠÙ† â€” ÙŠØªØ·Ù„Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†</small>
          </div>
          <button data-task-id="task2" class="taskBtn">ØªÙ†ÙÙŠØ°</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===== Telegram Mini App bootstrapping =====
    window.tg = window.Telegram ? window.Telegram.WebApp : null;
    const tg = window.tg;
    if (tg) {
      tg.ready();
      try { tg.expand(); } catch (e) {}
      // Ù…ÙˆØ§Ø²Ù†Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø«ÙŠÙ… ØªÙ„ÙŠØ¬Ø±Ø§Ù…
      const theme = tg.themeParams || {};
      if (theme.bg_color) document.body.style.background = theme.bg_color;
    }

    // ===== AdsGram init =====
    const blockId = 'int-14053'; // <-- blockId Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡
    let AdController = null;
    try {
      window.AdController = AdController = window.Adsgram.init({ blockId });
    } catch (e) {
      console.warn('AdsGram init failed:', e);
    }

    // ===== UI helpers =====
    const btn = document.getElementById('watchAdBtn');
    const status = document.getElementById('status');
    const reward = document.getElementById('reward');
    const rewardLink = document.getElementById('rewardLink');
    const errorBox = document.getElementById('errorBox');

    function setStatus(text, kind) {
      status.textContent = text;
      status.className = `pill ${kind || ''}`;
      status.classList.remove('hidden');
    }
    function clearStatus() {
      status.classList.add('hidden');
    }

    // Ø¹Ø¯Ù‘Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ ØµÙØ­Ø© Ø®Ø§ØµØ©)
    rewardLink.href = 'https://t.me/';

    // ===== Show ad on click (Rewarded logic) =====
    btn.addEventListener('click', async () => {
      clearStatus(); errorBox.classList.add('hidden'); reward.classList.add('hidden');
      btn.disabled = true;
      if (tg && tg.HapticFeedback) {
        try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {}
      }
      if (!AdController || !AdController.show) {
        setStatus('Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† ØºÙŠØ± Ø¬Ø§Ù‡Ø²', 'err');
        btn.disabled = false; return;
      }
      setStatus('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†â€¦', '');
      try {
        const result = await AdController.show();
        // ÙÙŠ rewarded: ÙŠØªØ­Ù‚Ù‚ done && !error Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        // ÙÙŠ interstitial: ØªØªØ­Ù‚Ù‚ Ø­ØªÙ‰ Ù„Ùˆ Ø£ØºÙ„Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† â€” Ø§Ø¹Ù…Ù„ Ù…Ù†Ø·Ù‚Ùƒ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„ÙˆÙƒ
        if (result && result.done && !result.error) {
          setStatus('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© âœ”', 'ok');
          reward.classList.remove('hidden');
          if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('success'); } catch (e) {}
        } else {
          setStatus('Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©', 'err');
        }
      } catch (err) {
        console.warn('Ads error', err);
        errorBox.classList.remove('hidden');
        setStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„', 'err');
        if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('error'); } catch (e) {}
      } finally {
        btn.disabled = false;
      }
    });

    // ØªØ­Ø°ÙŠØ± Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø®Ø§Ø±Ø¬ ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
    if (!tg) {
      console.info('ÙŠÙÙØ¶Ù‘ÙÙ„ ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¹Ø¨Ø± Ø²Ø± web_app ÙÙŠ Ø§Ù„Ø¨ÙˆØª.');
    }
  </script>

  <!-- Firebase + Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 1) Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§
    const firebaseConfig = {
      // TODO: Ø§Ù„ØµÙ‚ Ù…ÙØ§ØªÙŠØ­ Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    // 2) Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Helpers Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
    const tzOffsetMs = new Date().getTimezoneOffset() * 60000; // Ø³Ù†Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØªØµÙØ­Ø› ÙŠÙ…ÙƒÙ† ØªØ¹ÙˆÙŠØ¶Ù‡ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø§Ø­Ù‚Ù‹Ø§
    function todayKey() {
      const d = new Date(Date.now());
      // Ù…ÙØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ… YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const coinsEl = document.getElementById('coins');
    const levelTodayEl = document.getElementById('levelToday');
    const cooldownEl = document.getElementById('cooldown');
    const tasksTodayEl = document.getElementById('tasksToday');
    const dailyBtn = document.getElementById('claimDailyBtn');
    const dailyStatus = document.getElementById('dailyStatus');

    const taskButtons = Array.from(document.querySelectorAll('.taskBtn'));

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let uid = null;          // uid Ù…Ù† Firebase (Ù…Ø¬Ù‡ÙˆÙ„)
    let tgId = null;         // Telegram user id
    let userDocRef = null;

    // Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù… Mini App
    function getTelegramId() {
      try {
        const u = window.tg?.initDataUnsafe?.user;
        return u?.id ? String(u.id) : null;
      } catch (e) { return null; }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function ensureUser() {
      tgId = getTelegramId();
      if (!tgId) {
        console.warn('Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ù…Ø¹Ø±Ù ØªÙ„ÙŠØ¬Ø±Ø§Ù… â€” Ø§ÙØªØ­ Ø§Ù„Ù…ÙŠÙ†ÙŠ Ø¢Ø¨ Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù….');
      }
      userDocRef = doc(db, 'users', tgId || 'debug-guest');
      const snap = await getDoc(userDocRef);
      const base = {
        tgId: tgId || null,
        coins: 0,
        levels: {},             // map: dayKey -> count
        lastLevelAt: 0,         // timestamp ms
        tasks: {},              // map: dayKey -> {count: number}
        lastTaskAt: 0,
        daily: {},              // map: dayKey -> {claimed: bool, amount: number}
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      };
      if (!snap.exists()) {
        await setDoc(userDocRef, base);
        return base;
      } else {
        return snap.data();
      }
    }

    function setUI(data){
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const cdSec = Math.max(0, Math.ceil(( (data.lastLevelAt||0) + 60*1000 - Date.now() )/1000));
      coinsEl.textContent = Number(data.coins||0).toFixed(2).replace(/\.00$/, '');
      levelTodayEl.textContent = levelCount;
      cooldownEl.textContent = cdSec>0 ? `${cdSec} Ø«Ø§Ù†ÙŠØ©` : 'Ø¬Ø§Ù‡Ø²';
      tasksTodayEl.textContent = tasksCount;
    }

    async function loadAndSetUI(){
      const snap = await getDoc(userDocRef);
      if (snap.exists()) setUI(snap.data());
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª)
    async function canGainLevel(){
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const lastAt = data.lastLevelAt || 0;
      const onCooldown = (Date.now() - lastAt) < 60*1000; // 1 Ø¯Ù‚ÙŠÙ‚Ø©
      if (levelCount >= 20) return {ok:false, reason:'ØªÙ… Ø¨Ù„ÙˆØº 20 Ù„ÙÙ„ Ø§Ù„ÙŠÙˆÙ…'};
      if (onCooldown) return {ok:false, reason:'Ø§Ù†ØªØ¸Ø± Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª'};
      return {ok:true, data};
    }

    async function gainLevel(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = Object.assign({}, data.levels||{});
      lvls[day] = (lvls[day]||0)+1;
      await updateDoc(userDocRef, {
        levels: lvls,
        lastLevelAt: Date.now(),
        updatedAt: serverTimestamp(),
      });
      await loadAndSetUI();
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‡Ø§Ù… (ÙƒÙ„ Ù…Ù‡Ù…Ø© = 1 ÙƒÙˆÙŠÙ† ÙˆØªØªØ·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†)
    async function completeTaskOnce(taskId){
      // Ø´ØºÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹
      if (!window.AdController || !window.AdController.show) throw new Error('Ads not ready');
      const r = await window.AdController.show();
      if (!(r && r.done && !r.error)) throw new Error('Ù„Ù… ØªÙƒØªÙ…Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');

      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const tasks = Object.assign({} , data.tasks||{});
      const dayObj = Object.assign({count:0, completed: {}}, tasks[day]||{});
      if (dayObj.completed && dayObj.completed[taskId]) {
        throw new Error('Ø£ØªÙ…Ù…Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„');
      }
      dayObj.count = (dayObj.count||0)+1;
      dayObj.completed = Object.assign({}, dayObj.completed, {[taskId]: true});
      tasks[day] = dayObj;

      const newCoins = Number(data.coins||0) + 1; // 1 ÙƒÙˆÙŠÙ† Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©
      await updateDoc(userDocRef, {
        tasks,
        coins: newCoins,
        lastTaskAt: Date.now(),
        updatedAt: serverTimestamp(),
      });
      await loadAndSetUI();
      return {ok:true};
    }

    // Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ© (Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© 0.2 Ø¥Ù„Ù‰ 1.5) â€” ØªØªØ·Ù„Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ£ØªÙ… Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø§Ù„ÙŠÙˆÙ…
    function randomDaily(){
      const min = 0.2, max = 1.5;
      return +(Math.random()*(max-min)+min).toFixed(2);
    }

    async function claimDaily(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const daily = Object.assign({}, data.daily||{});

      if (daily[day]?.claimed) throw new Error('Ø§Ø³ØªÙ„Ù…Øª Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„');
      if (lvls < 1) throw new Error('Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ù‹Ø§');
      if (tasksCount < 1) throw new Error('Ø£ÙƒÙ…Ù„ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ù‹Ø§');

      const amount = randomDaily();
      const newCoins = Number(data.coins||0) + amount;
      daily[day] = { claimed: true, amount };

      await updateDoc(userDocRef, {
        coins: newCoins,
        daily,
        updatedAt: serverTimestamp(),
      });

      await loadAndSetUI();
      return amount;
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('watchAdBtn').addEventListener('click', async () => {
      // Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØŒ Ù„ÙƒÙ† Ù†Ø¶ÙŠÙ Ø·Ø¨Ù‚Ø© "Ù„ÙŠÙÙ„" ÙÙˆÙ‚Ù‡
      try {
        const can = await canGainLevel();
        if (!can.ok) { setStatus(can.reason, 'err'); return; }
        const res = await window.AdController.show();
        if (res && res.done && !res.error) {
          await gainLevel();
          setStatus('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ âœ”', 'ok');
        } else {
          setStatus('Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©', 'err');
        }
      } catch (e) {
        setStatus(e.message || 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„', 'err');
      }
    });

    taskButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        try {
          await completeTaskOnce(btn.dataset.taskId);
          setStatus('Ø£ÙÙ†Ø¬Ø²Øª Ø§Ù„Ù…Ù‡Ù…Ø© +1 ÙƒÙˆÙŠÙ†', 'ok');
        } catch (e) {
          setStatus(e.message || 'ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©', 'err');
        } finally { btn.disabled = false; }
      });
    });

    dailyBtn.addEventListener('click', async ()=>{
      dailyStatus.classList.add('hidden');
      try {
        const amount = await claimDaily();
        dailyStatus.textContent = `ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ ${amount} ÙƒÙˆÙŠÙ† ğŸ‰`;
        dailyStatus.className = 'pill ok';
        dailyStatus.classList.remove('hidden');
      } catch (e) {
        dailyStatus.textContent = e.message || 'ØªØ¹Ø°Ø± ØµØ±Ù Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©';
        dailyStatus.className = 'pill err';
        dailyStatus.classList.remove('hidden');
      }
    });

    // 3) ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„ Ø«Ù… ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      const data = await ensureUser();
      setUI(data);
    });

  </script>
</body>
</html>
