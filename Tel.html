<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini App Coins</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Font Awesome للايقونات -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap');
    
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
    }
    
    .gold-gradient {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    }
    
    .gold-text {
      background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .diamond-btn {
      background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
      box-shadow: 0 4px 15px 0 rgba(0, 210, 255, 0.5);
      transition: all 0.3s ease;
    }
    
    .diamond-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px 0 rgba(0, 210, 255, 0.7);
    }
    
    .diamond-btn:disabled {
      background: #4b5563;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .ad-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    
    .ad-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 400px;
      background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(255, 215, 0, 0.3);
    }
    
    .countdown {
      font-size: 2.5rem;
      font-weight: 800;
      color: #f6d365;
      text-shadow: 0 0 10px rgba(246, 211, 101, 0.5);
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .coin-animation {
      animation: coinSpin 1s ease-out;
    }
    
    @keyframes coinSpin {
      0% { transform: scale(0) rotate(0deg); }
      100% { transform: scale(1) rotate(360deg); }
    }
    
    .progress-bar {
      transition: width 0.5s ease-in-out;
    }
    
    .nav-btn.active {
      position: relative;
    }
    
    .nav-btn.active::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background: #3b82f6;
      border-radius: 50%;
    }
    
    .card {
      background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .header-glow {
      box-shadow: 0 4px 20px rgba(59, 130, 246, 0.3);
    }
    
    .ad-container {
      margin: 20px 0;
      min-height: 250px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 1001;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
    }
    
    @keyframes slideIn {
      from { top: -50px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }
    
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; visibility: hidden; }
    }
  </style>
</head>
<body class="text-white flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center header-glow">
    <h1 class="text-xl font-bold gold-text">🚀 Mini App</h1>
    <div id="coinsBox" class="bg-blue-600 px-4 py-1 rounded-full flex items-center gap-1 shadow-md">
      <i class="fas fa-coins animate-pulse"></i> 
      <span id="coinsValue">0</span>
    </div>
  </header>

  <!-- Pages -->
  <main id="pageHome" class="flex-1 p-6 text-center">
    <div class="card p-6 mb-6">
      <h2 class="text-lg mb-2 text-gray-300">رصيدك الحالي</h2>
      <p id="coins" class="text-5xl font-bold gold-text my-4">0 <i class="fas fa-coins"></i></p>
      <button onclick="showPage('tasks')" class="diamond-btn px-6 py-3 rounded-xl text-white font-bold mt-4">
        ابدأ كسب النقود <i class="fas fa-arrow-left ml-2"></i>
      </button>
    </div>
    
    <div class="card p-5">
      <h3 class="text-lg mb-3"><i class="fas fa-trophy mr-2 gold-text"></i>المتصدرون</h3>
      <div id="leaderboard" class="text-right space-y-2">
        <div class="flex justify-between items-center p-2 bg-blue-800 bg-opacity-30 rounded-lg">
          <span class="text-yellow-400">#1</span>
          <span>مستخدم 1</span>
          <span>1500 <i class="fas fa-coins text-yellow-400"></i></span>
        </div>
        <div class="flex justify-between items-center p-2 bg-blue-800 bg-opacity-30 rounded-lg">
          <span class="text-gray-300">#2</span>
          <span>مستخدم 2</span>
          <span>1200 <i class="fas fa-coins text-yellow-400"></i></span>
        </div>
        <div class="flex justify-between items-center p-2 bg-blue-800 bg-opacity-30 rounded-lg">
          <span class="text-yellow-600">#3</span>
          <span>مستخدم 3</span>
          <span>900 <i class="fas fa-coins text-yellow-400"></i></span>
        </div>
      </div>
    </div>
  </main>

  <main id="pageTasks" class="hidden flex-1 p-6 text-center">
    <div class="card p-6 space-y-6">
      <h2 class="text-xl font-bold gold-text"><i class="fas fa-film mr-2"></i>المهام اليومية</h2>
      
      <div class="space-y-2">
        <div class="flex justify-between text-sm text-gray-300">
          <span>تقدمك اليوم</span>
          <span id="taskInfo">0 / 100 إعلان</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-3">
          <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full progress-bar"></div>
        </div>
      </div>
      
      <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
        <h3 class="text-lg mb-2">شاهد الإعلان واحصل على مكافأة</h3>
        <p class="text-gray-400 text-sm mb-4">اضغط على الزر بالأسفل وشاهد الإعلان لمدة 15 ثانية</p>
        
        <!-- حاوية الإعلان -->
        <div id="adContainer" class="ad-container">
          <p>سوف يظهر الإعلان هنا بعد النقر على الزر</p>
        </div>
        
        <button id="watchAdBtn" class="diamond-btn px-6 py-3 rounded-xl text-white font-bold text-lg pulse w-full mt-4">
          <i class="fas fa-play-circle mr-2"></i>شاهد إعلان
        </button>
      </div>
      
      <div class="grid grid-cols-3 gap-3 text-center">
        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
          <div class="text-blue-400 text-2xl"><i class="fas fa-bolt"></i></div>
          <div class="text-sm">15 ثانية</div>
        </div>
        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
          <div class="text-green-400 text-2xl"><i class="fas fa-lock-open"></i></div>
          <div class="text-sm">مجاني</div>
        </div>
        <div class="bg-gray-800 p-3 rounded-lg border border-gray-700">
          <div class="text-yellow-400 text-2xl"><i class="fas fa-gift"></i></div>
          <div class="text-sm">1 عملة</div>
        </div>
      </div>
    </div>
  </main>

  <main id="pageProfile" class="hidden flex-1 p-6 text-center">
    <div class="card p-6 space-y-4">
      <div class="w-20 h-20 mx-auto rounded-full gold-gradient flex items-center justify-center">
        <i class="fas fa-user text-white text-3xl"></i>
      </div>
      <h2 class="text-xl font-bold gold-text">👤 حسابك</h2>
      
      <div class="space-y-3 text-right">
        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
          <span class="text-gray-400">المعرف:</span>
          <span id="userId">-</span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
          <span class="text-gray-400">النقاط:</span>
          <span id="coinsProfile" class="text-yellow-400">0 <i class="fas fa-coins"></i></span>
        </div>
        <div class="flex justify-between items-center p-3 bg-gray-800 rounded-lg">
          <span class="text-gray-400">الإعلانات اليوم:</span>
          <span id="tasksProfile">0</span>/100
        </div>
      </div>
      
      <div class="pt-4 border-t border-gray-700">
        <button class="px-4 py-2 bg-red-600 bg-opacity-20 text-red-400 rounded-lg text-sm">
          <i class="fas fa-sign-out-alt mr-1"></i> تسجيل الخروج
        </button>
      </div>
    </div>
  </main>

  <!-- Bottom Nav -->
  <nav class="flex justify-around bg-gray-800 py-3 border-t border-gray-700 shadow-lg">
    <button onclick="showPage('home')" class="nav-btn text-blue-400 active"><i class="fas fa-home text-lg"></i></button>
    <button onclick="showPage('tasks')" class="nav-btn text-gray-400"><i class="fas fa-film text-lg"></i></button>
    <button onclick="showPage('profile')" class="nav-btn text-gray-400"><i class="fas fa-user text-lg"></i></button>
  </nav>

  <!-- Ad Modal -->
  <div id="adModal" class="ad-modal">
    <div class="ad-content">
      <div class="gold-gradient p-4 text-center">
        <h2 class="text-xl font-bold"><i class="fas fa-ad mr-2"></i>إعلان</h2>
      </div>
      
      <div class="p-6 text-center">
        <div class="countdown mb-4" id="countdown">15</div>
        <p class="text-gray-300 mb-6">جاري تحميل الإعلان، يرجى الانتظار...</p>
        
        <div class="w-full bg-gray-700 rounded-full h-2 mb-6">
          <div id="adProgress" class="bg-gradient-to-r from-blue-500 to-purple-600 h-2 rounded-full"></div>
        </div>
        
        <div class="text-yellow-400 text-4xl mb-4 animate-pulse">
          <i class="fas fa-ad"></i>
        </div>
        
        <p class="text-gray-400 text-sm">ستحصل على <span class="text-yellow-400">1</span> عملة بعد انتهاء الإعلان</p>
      </div>
    </div>
  </div>

<script>
  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
    authDomain: "hhhhhh-d4fb8.firebaseapp.com",
    databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
    projectId: "hhhhhh-d4fb8",
    storageBucket: "hhhhhh-d4fb8.appspot.com",
    messagingSenderId: "24512338206",
    appId: "1:24512338206:web:dfe045db59bd3434a2110f",
    measurementId: "G-HD4R7GNQ5H"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Telegram User
  const tg = window.Telegram.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id?.toString() || "guest";
  document.getElementById("userId").textContent = userId;

  // User Data
  let coins = 0;
  let tasksToday = 0;
  const DAILY_LIMIT = 100;
  const AD_DURATION = 15; // 15 ثانية

  // متغيرات التحكم بالإعلان
  let isAdPlaying = false;
  let adScriptLoaded = false;

  // Load User
  async function loadUser() {
    const today = new Date().toISOString().split("T")[0];
    const ref = db.collection("users").doc(userId);
    const docSnap = await ref.get();
    if (!docSnap.exists) {
      await ref.set({ coins: 0, tasksToday: 0, lastTaskDate: today });
      coins = 0; tasksToday = 0;
    } else {
      const data = docSnap.data();
      coins = data.coins;
      if (data.lastTaskDate !== today) {
        tasksToday = 0;
        await ref.update({ tasksToday: 0, lastTaskDate: today });
      } else {
        tasksToday = data.tasksToday;
      }
    }
    updateUI();
  }

  // Update UI
  function updateUI() {
    document.getElementById("coins").innerHTML = coins + ' <i class="fas fa-coins"></i>';
    document.getElementById("coinsValue").textContent = coins;
    document.getElementById("coinsBox").classList.add('animate-pulse');
    setTimeout(() => {
      document.getElementById("coinsBox").classList.remove('animate-pulse');
    }, 1000);
    
    document.getElementById("coinsProfile").textContent = coins;
    document.getElementById("tasksProfile").textContent = tasksToday;
    document.getElementById("taskInfo").textContent = tasksToday + "/" + DAILY_LIMIT + " إعلان";
    document.getElementById("progressBar").style.width = (tasksToday/DAILY_LIMIT*100)+"%";
  }

  // Watch Ad
  document.getElementById("watchAdBtn").addEventListener("click", () => {
    if (isAdPlaying) {
      showNotification("⏳ الإعلان قيد التشغيل بالفعل", "info");
      return;
    }
    
    if (tasksToday >= DAILY_LIMIT) {
      showNotification("❌ وصلت الحد اليومي للإعلانات", "error");
      return;
    }
    
    // عرض نافذة الإعلان
    const adModal = document.getElementById("adModal");
    adModal.style.display = "block";
    isAdPlaying = true;
    
    // تعطيل الزر أثناء عرض الإعلان
    const btn = document.getElementById("watchAdBtn");
    btn.disabled = true;
    btn.classList.remove("pulse");
    
    // بدء العد التنازلي (15 ثانية)
    let countdown = AD_DURATION;
    const countdownElement = document.getElementById("countdown");
    const adProgress = document.getElementById("adProgress");
    
    const countdownInterval = setInterval(() => {
      countdown--;
      countdownElement.textContent = countdown;
      adProgress.style.width = ((AD_DURATION - countdown) / AD_DURATION * 100) + "%";
      
      if (countdown <= 0) {
        clearInterval(countdownInterval);
        finishAdViewing();
      }
    }, 1000);
    
    // تحميل وتشغيل الإعلان بعد تأخير بسيط
    if (!adScriptLoaded) {
      const adScript = document.createElement('script');
      adScript.src = '//libtl.com/sdk.js';
      adScript.setAttribute('data-zone', '9747739');
      adScript.setAttribute('data-sdk', 'show_9747739');
      adScript.onload = () => {
        adScriptLoaded = true;
        playAd();
      };
      document.head.appendChild(adScript);
    } else {
      playAd();
    }
  });

  // تشغيل الإعلان
  function playAd() {
    if (typeof window.show_9747739 === 'function') {
      window.show_9747739({
        type: 'inApp',
        inAppSettings: { 
          frequency: 1,
          capping: 0.0014,
          interval: 5,
          timeout: 0.5,
          everyPage: false 
        }
      });
    }
  }

  // إنهاء عرض الإعلان
  async function finishAdViewing() {
    // إخفاء نافذة الإعلان
    const adModal = document.getElementById("adModal");
    adModal.style.display = "none";
    isAdPlaying = false;
    
    // زيادة الرصيد
    coins++;
    tasksToday++;
    
    // حفظ البيانات في Firebase
    await db.collection("users").doc(userId).set({
      coins,
      tasksToday,
      lastTaskDate: new Date().toISOString().split("T")[0]
    }, { merge: true });
    
    // تحديث الواجهة
    updateUI();
    
    // إعادة تمكين زر مشاهدة الإعلان
    const btn = document.getElementById("watchAdBtn");
    btn.disabled = false;
    btn.classList.add("pulse");
    
    // عرض رسالة النجاح
    showNotification("✅ مبروك! لقد ربحت 1 عملة", "success");
    
    // تأثير العملة
    document.getElementById("coins").classList.add("coin-animation");
    setTimeout(() => {
      document.getElementById("coins").classList.remove("coin-animation");
    }, 1000);
  }

  // عرض الإشعارات
  function showNotification(message, type) {
    // إزالة أي إشعارات سابقة
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());
    
    const notification = document.createElement("div");
    notification.className = `notification ${
      type === "error" ? "bg-red-600" : 
      type === "info" ? "bg-blue-600" : "bg-green-600"
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 3000);
  }

  // Pages
  function showPage(page) {
    document.querySelectorAll("main").forEach(m => m.classList.add("hidden"));
    document.getElementById("page"+page.charAt(0).toUpperCase()+page.slice(1)).classList.remove("hidden");
    
    // تحديث أزرار التنقل
    document.querySelectorAll("nav button").forEach(btn => {
      btn.classList.remove("text-blue-400");
      btn.classList.add("text-gray-400");
      btn.classList.remove("active");
    });
    
    const activeBtn = document.querySelector(`nav button[onclick="showPage('${page}')"]`);
    activeBtn.classList.add("text-blue-400", "active");
    activeBtn.classList.remove("text-gray-400");
  }

  // تهيئة التطبيق
  loadUser();
</script>

</body>
</html>
