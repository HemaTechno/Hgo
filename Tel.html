<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† â€” AdsGram x Telegram Mini App</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- AdsGram SDK (vanilla JS) -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f1115;
      --card: #151922;
      --text: #e8ebf0;
      --muted: #a8b3c7;
      --accent: #22c55e;
      --accent-dark: #16a34a;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --purple: #a855f7;
      --gradient: linear-gradient(135deg, var(--accent), var(--info));
      --border-radius: 16px;
      --transition: all 0.3s ease;
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    html, body { 
      height: 100%; 
    }
    
    body {
      margin: 0; 
      font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); 
      color: var(--text);
      display: grid; 
      place-items: center;
      padding: 16px;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(34, 197, 94, 0.05) 0%, transparent 25%),
        radial-gradient(circle at 85% 30%, rgba(59, 130, 246, 0.05) 0%, transparent 25%);
    }
    
    .wrap { 
      width: min(680px, 92vw); 
      animation: fadeIn 0.5s ease-out;
    }
    
    .card {
      background: var(--card); 
      border-radius: var(--border-radius); 
      padding: 28px; 
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.05);
      position: relative;
      overflow: hidden;
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient);
    }
    
    h1 { 
      margin: 0 0 12px; 
      font-size: 26px; 
      font-weight: 700;
      background: var(--gradient);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display: inline-block;
    }
    
    p { 
      margin: 0 0 20px; 
      color: var(--muted); 
      line-height: 1.6; 
      font-size: 15px;
    }
    
    .actions { 
      display: flex; 
      gap: 12px; 
      align-items: center; 
      margin-bottom: 20px;
    }
    
    button {
      appearance: none; 
      border: 0; 
      border-radius: 14px; 
      padding: 14px 22px; 
      font-weight: 700; 
      cursor: pointer;
      font-family: inherit;
      font-size: 15px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    #watchAdBtn { 
      background: var(--accent); 
      color: #fff;
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
    }
    
    #watchAdBtn:hover:not([disabled]) {
      background: var(--accent-dark);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(34, 197, 94, 0.4);
    }
    
    #watchAdBtn[disabled] { 
      opacity: .6; 
      cursor: not-allowed; 
      transform: none !important;
      box-shadow: none !important;
    }
    
    .pill { 
      padding: 10px 14px; 
      border-radius: 999px; 
      font-size: 13px; 
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .pill.ok { 
      background: rgba(34, 197, 94, 0.18); 
      color: #6ee7b7; 
    }
    
    .pill.err { 
      background: rgba(239, 68, 68, 0.15); 
      color: #fecaca; 
    }
    
    .pill.warn { 
      background: rgba(245, 158, 11, 0.15); 
      color: #fde68a; 
    }
    
    .pill.info { 
      background: rgba(59, 130, 246, 0.15); 
      color: #93c5fd; 
    }
    
    .hidden { 
      display: none; 
    }
    
    a.cta { 
      color: var(--accent); 
      text-decoration: none; 
      font-weight: 700; 
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    a.cta:hover {
      color: var(--accent-dark);
      text-decoration: underline;
    }
    
    .footer { 
      margin-top: 20px; 
      font-size: 12px; 
      color: var(--muted); 
      opacity: .8; 
      text-align: center;
      padding: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .grid { 
      display: grid; 
      gap: 16px; 
      margin-bottom: 20px;
    }
    
    .two { 
      grid-template-columns: 1fr 1fr; 
    }
    
    .stat { 
      background: rgba(14, 18, 32, 0.6); 
      border-radius: 14px; 
      padding: 16px; 
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }
    
    .stat:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }
    
    .stat h3 { 
      margin: 0 0 8px; 
      font-size: 13px; 
      color: #a8b3c7; 
      font-weight: 600; 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stat .v { 
      font-size: 22px; 
      font-weight: 800; 
    }
    
    .task { 
      display:flex; 
      justify-content: space-between; 
      align-items:center; 
      padding: 14px; 
      border-radius: 12px; 
      background: rgba(14, 18, 32, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.05);
      transition: var(--transition);
    }
    
    .task:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    
    .task small { 
      color: var(--muted); 
      font-size: 12px;
    }
    
    .taskBtn {
      background: var(--info);
      color: white;
      padding: 8px 14px;
      font-size: 13px;
    }
    
    .taskBtn:hover:not([disabled]) {
      background: #2563eb;
      transform: translateY(-1px);
    }
    
    .taskBtn[disabled] {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    hr.divider {
      border: 0;
      border-top: 1px solid rgba(255, 255, 255, 0.08); 
      margin: 22px 0; 
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding: 12px;
      background: rgba(14, 18, 32, 0.6);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: var(--gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .user-id {
      font-size: 12px;
      color: var(--muted);
    }
    
    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 20px;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Responsive adjustments */
    @media (max-width: 600px) {
      .two {
        grid-template-columns: 1fr;
      }
      
      .card {
        padding: 20px;
      }
      
      .actions {
        flex-direction: column;
        align-items: stretch;
      }
      
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
      <div id="userInfo" class="user-info hidden">
        <div class="user-avatar">
          <i class="fas fa-user"></i>
        </div>
        <div class="user-details">
          <div class="user-name" id="userName">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
          <div class="user-id" id="userId">ID: </div>
        </div>
      </div>
      
      <h1>Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©</h1>
      <p>Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø¨Ø§Ù„Ø£Ø³ÙÙ„ Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø¥Ø¹Ù„Ø§Ù† <strong>AdsGram</strong>. Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.</p>
      
      <div class="actions">
        <button id="watchAdBtn">
          <i class="fas fa-play-circle"></i>
          Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        </button>
        <span id="status" class="pill hidden"></span>
      </div>
      
      <div id="reward" class="hidden" style="margin-top:16px">
        <p class="pill ok">
          <i class="fas fa-trophy"></i>
          ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! ØªÙ… ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©.
        </p>
        <p>
          <a id="rewardLink" class="cta" href="#" target="_blank" rel="noopener">
            <i class="fas fa-gift"></i>
            Ø§ÙØªØ­ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ø¢Ù†
          </a>
        </p>
      </div>
      
      <div id="errorBox" class="hidden" style="margin-top:16px">
        <p class="pill err">
          <i class="fas fa-exclamation-triangle"></i>
          Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.
        </p>
      </div>
      
      <div class="footer">Mini App ÙŠØ¹Ù…Ù„ Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù…. Ù„Ùˆ ÙØªØ­ØªÙ‡ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù‚Ø¯ Ù„Ø§ ØªØ¸Ù‡Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.</div>

      <hr class="divider">

      <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
      <div class="grid two">
        <div class="stat">
          <h3><i class="fas fa-coins"></i> Ø§Ù„Ø±ØµÙŠØ¯ (Coins)</h3>
          <div class="v" id="coins">0</div>
        </div>
        <div class="stat">
          <h3><i class="fas fa-chart-line"></i> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="v"><span id="levelToday">0</span>/20</div>
        </div>
        <div class="stat">
          <h3><i class="fas fa-clock"></i> Ø§Ù†ØªØ¸Ø§Ø± Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª</h3>
          <div class="v" id="cooldown">Ø¬Ø§Ù‡Ø²</div>
        </div>
        <div class="stat">
          <h3><i class="fas fa-tasks"></i> Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="v" id="tasksToday">0</div>
        </div>
      </div>

      <div class="grid">
        <button id="claimDailyBtn">
          <i class="fas fa-calendar-day"></i>
          Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        </button>
        <span id="dailyStatus" class="pill hidden"></span>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ù…Ù‡Ø§Ù… ØªØ¬Ø±ÙŠØ¨ÙŠØ© -->
      <div class="grid">
        <div class="task">
          <div>
            <div>Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… 1</div>
            <small>ÙŠÙƒØ³Ø¨ 1 ÙƒÙˆÙŠÙ† â€” ÙŠØªØ·Ù„Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†</small>
          </div>
          <button data-task-id="task1" class="taskBtn">
            <i class="fas fa-play"></i>
            ØªÙ†ÙÙŠØ°
          </button>
        </div>
        <div class="task">
          <div>
            <div>Ù…Ù‡Ù…Ø© Ø±Ù‚Ù… 2</div>
            <small>ÙŠÙƒØ³Ø¨ 1 ÙƒÙˆÙŠÙ† â€” ÙŠØªØ·Ù„Ø¨ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù†</small>
          </div>
          <button data-task-id="task2" class="taskBtn">
            <i class="fas fa-play"></i>
            ØªÙ†ÙÙŠØ°
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== Telegram Mini App bootstrapping =====
    window.tg = window.Telegram ? window.Telegram.WebApp : null;
    const tg = window.tg;
    if (tg) {
      tg.ready();
      try { tg.expand(); } catch (e) {}
      // Ù…ÙˆØ§Ø²Ù†Ø© Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø«ÙŠÙ… ØªÙ„ÙŠØ¬Ø±Ø§Ù…
      const theme = tg.themeParams || {};
      if (theme.bg_color) document.body.style.background = theme.bg_color;
    }

    // ===== AdsGram init =====
    const blockId = 'int-14053'; // <-- blockId Ø§Ù„Ø°ÙŠ Ø£Ø¹Ø·ÙŠØªÙ†ÙŠ Ø¥ÙŠØ§Ù‡
    let AdController = null;
    try {
      window.AdController = AdController = window.Adsgram.init({ blockId });
    } catch (e) {
      console.warn('AdsGram init failed:', e);
    }

    // ===== UI helpers =====
    const btn = document.getElementById('watchAdBtn');
    const status = document.getElementById('status');
    const reward = document.getElementById('reward');
    const rewardLink = document.getElementById('rewardLink');
    const errorBox = document.getElementById('errorBox');
    const userInfo = document.getElementById('userInfo');
    const userName = document.getElementById('userName');
    const userId = document.getElementById('userId');

    function setStatus(text, kind) {
      status.textContent = text;
      status.className = `pill ${kind || ''}`;
      status.classList.remove('hidden');
    }
    
    function clearStatus() {
      status.classList.add('hidden');
    }

    // Ø¹Ø¯Ù‘Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© ÙƒÙ…Ø§ ØªØ±ÙŠØ¯ (Ù…Ø«Ù„Ø§Ù‹ Ø±Ø§Ø¨Ø· ØªÙ†Ø²ÙŠÙ„ Ø£Ùˆ ØµÙØ­Ø© Ø®Ø§ØµØ©)
    rewardLink.href = 'https://t.me/';

    // ===== Show ad on click (Rewarded logic) =====
    btn.addEventListener('click', async () => {
      clearStatus(); 
      errorBox.classList.add('hidden'); 
      reward.classList.add('hidden');
      btn.disabled = true;
      
      if (tg && tg.HapticFeedback) {
        try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {}
      }
      
      if (!AdController || !AdController.show) {
        setStatus('Ø§Ù„Ù…ÙƒÙˆÙ‘Ù† ØºÙŠØ± Ø¬Ø§Ù‡Ø²', 'err');
        btn.disabled = false; 
        return;
      }
      
      setStatus('Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†â€¦', 'info');
      
      try {
        const result = await AdController.show();
        // ÙÙŠ rewarded: ÙŠØªØ­Ù‚Ù‚ done && !error Ø¹Ù†Ø¯Ù…Ø§ ÙŠØ´Ø§Ù‡Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­ØªÙ‰ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        // ÙÙŠ interstitial: ØªØªØ­Ù‚Ù‚ Ø­ØªÙ‰ Ù„Ùˆ Ø£ØºÙ„Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† â€” Ø§Ø¹Ù…Ù„ Ù…Ù†Ø·Ù‚Ùƒ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„ÙˆÙƒ
        if (result && result.done && !result.error) {
          setStatus('ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© âœ”', 'ok');
          reward.classList.remove('hidden');
          if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('success'); } catch (e) {}
        } else {
          setStatus('Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©', 'err');
        }
      } catch (err) {
        console.warn('Ads error', err);
        errorBox.classList.remove('hidden');
        setStatus('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„', 'err');
        if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('error'); } catch (e) {}
      } finally {
        btn.disabled = false;
      }
    });

    // ØªØ­Ø°ÙŠØ± Ø®ÙÙŠÙ Ø¹Ù†Ø¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø®Ø§Ø±Ø¬ ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±)
    if (!tg) {
      console.info('ÙŠÙÙØ¶Ù‘ÙÙ„ ÙØªØ­ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¯Ø§Ø®Ù„ ØªÙ„ÙŠØ¬Ø±Ø§Ù… Ø¹Ø¨Ø± Ø²Ø± web_app ÙÙŠ Ø§Ù„Ø¨ÙˆØª.');
    }
  </script>

  <!-- Firebase + Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† (Module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 1) Ø¶Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f",
      measurementId: "G-HD4R7GNQ5H"
    };

    // 2) Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Helpers Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
    function todayKey() {
      const d = new Date();
      // Ù…ÙØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ… YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const coinsEl = document.getElementById('coins');
    const levelTodayEl = document.getElementById('levelToday');
    const cooldownEl = document.getElementById('cooldown');
    const tasksTodayEl = document.getElementById('tasksToday');
    const dailyBtn = document.getElementById('claimDailyBtn');
    const dailyStatus = document.getElementById('dailyStatus');
    const taskButtons = Array.from(document.querySelectorAll('.taskBtn'));

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    let uid = null;          // uid Ù…Ù† Firebase (Ù…Ø¬Ù‡ÙˆÙ„)
    let tgId = null;         // Telegram user id
    let userDocRef = null;
    let cooldownInterval = null;

    // Ø¬Ù„Ø¨ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† ØªÙ„ÙŠØ¬Ø±Ø§Ù… Mini App
    function getTelegramUser() {
      try {
        const u = window.tg?.initDataUnsafe?.user;
        return u || null;
      } catch (e) { return null; }
    }

    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    function displayUserInfo(userData) {
      const tgUser = getTelegramUser();
      if (tgUser) {
        userName.textContent = tgUser.first_name || tgUser.username || 'Ù…Ø³ØªØ®Ø¯Ù… ØªÙ„ÙŠØ¬Ø±Ø§Ù…';
        userId.textContent = `ID: ${tgUser.id}`;
        userInfo.classList.remove('hidden');
      } else {
        userInfo.classList.add('hidden');
      }
    }

    // Ø¥Ù†Ø´Ø§Ø¡ / ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    async function ensureUser() {
      const tgUser = getTelegramUser();
      tgId = tgUser ? String(tgUser.id) : 'debug-guest';
      
      userDocRef = doc(db, 'users', tgId);
      const snap = await getDoc(userDocRef);
      
      const base = {
        tgId: tgId,
        tgUser: tgUser || null,
        coins: 0,
        date: todayKey(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        lastOutline: serverTimestamp(), // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        levels: {},             // map: dayKey -> count
        lastLevelAt: 0,         // timestamp ms
        tasks: {},              // map: dayKey -> {count: number}
        lastTaskAt: 0,
        daily: {},              // map: dayKey -> {claimed: bool, amount: number}
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      };
      
      if (!snap.exists()) {
        await setDoc(userDocRef, base);
        return base;
      } else {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©
        const existingData = snap.data();
        const updatedData = {
          ...base,
          ...existingData,
          updatedAt: serverTimestamp()
        };
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† coins Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØµØ­ÙŠØ­Ø©
        if (isNaN(updatedData.coins) || updatedData.coins === undefined) {
          updatedData.coins = 0;
        }
        
        await setDoc(userDocRef, updatedData, { merge: true });
        return updatedData;
      }
    }

    function setUI(data){
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const cdSec = Math.max(0, Math.ceil(( (data.lastLevelAt||0) + 60*1000 - Date.now() )/1000));
      
      // Ø¹Ø±Ø¶ coins Ù…Ø¹ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡Ø§ Ù‚ÙŠÙ…Ø© Ø±Ù‚Ù…ÙŠØ©
      const coinsValue = isNaN(data.coins) ? 0 : Number(data.coins);
      coinsEl.textContent = coinsValue.toFixed(2).replace(/\.00$/, '');
      
      levelTodayEl.textContent = levelCount;
      tasksTodayEl.textContent = tasksCount;
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ
      updateCooldownText(cdSec);
      
      // Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¤Ù‚Øª
      if (cooldownInterval) clearInterval(cooldownInterval);
      if (cdSec > 0) {
        cooldownInterval = setInterval(() => {
          const newCdSec = Math.max(0, Math.ceil(( (data.lastLevelAt||0) + 60*1000 - Date.now() )/1000));
          updateCooldownText(newCdSec);
          if (newCdSec <= 0) clearInterval(cooldownInterval);
        }, 1000);
      }
    }
    
    function updateCooldownText(seconds) {
      cooldownEl.textContent = seconds > 0 ? `${seconds} Ø«Ø§Ù†ÙŠØ©` : 'Ø¬Ø§Ù‡Ø²';
      cooldownEl.style.color = seconds > 0 ? (seconds <= 10 ? '#ef4444' : '#f59e0b') : '#22c55e';
    }

    async function loadAndSetUI(){
      const snap = await getDoc(userDocRef);
      if (snap.exists()) {
        const data = snap.data();
        setUI(data);
        displayUserInfo(data);
      }
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª)
    async function canGainLevel(){
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const lastAt = data.lastLevelAt || 0;
      const onCooldown = (Date.now() - lastAt) < 60*1000; // 1 Ø¯Ù‚ÙŠÙ‚Ø©
      
      if (levelCount >= 20) return {ok:false, reason:'ØªÙ… Ø¨Ù„ÙˆØº 20 Ù„ÙÙ„ Ø§Ù„ÙŠÙˆÙ…'};
      if (onCooldown) return {ok:false, reason:'Ø§Ù†ØªØ¸Ø± Ø¯Ù‚ÙŠÙ‚Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª'};
      return {ok:true, data};
    }

    async function gainLevel(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = Object.assign({}, data.levels||{});
      lvls[day] = (lvls[day]||0)+1;
      
      await updateDoc(userDocRef, {
        levels: lvls,
        lastLevelAt: Date.now(),
        coins: increment(1), // Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„Ø© Ù„ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù†
        date: todayKey(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
        lastOutline: serverTimestamp(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        updatedAt: serverTimestamp(),
      });
      
      await loadAndSetUI();
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ù‡Ø§Ù… (ÙƒÙ„ Ù…Ù‡Ù…Ø© = 1 ÙƒÙˆÙŠÙ† ÙˆØªØªØ·Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù†)
    async function completeTaskOnce(taskId){
      // Ø´ØºÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø£ÙˆÙ„Ø§Ù‹
      if (!window.AdController || !window.AdController.show) throw new Error('Ads not ready');
      const r = await window.AdController.show();
      if (!(r && r.done && !r.error)) throw new Error('Ù„Ù… ØªÙƒØªÙ…Ù„ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†');

      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const tasks = Object.assign({} , data.tasks||{});
      const dayObj = Object.assign({count:0, completed: {}}, tasks[day]||{});
      
      if (dayObj.completed && dayObj.completed[taskId]) {
        throw new Error('Ø£ØªÙ…Ù…Øª Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„');
      }
      
      dayObj.count = (dayObj.count||0)+1;
      dayObj.completed = Object.assign({}, dayObj.completed, {[taskId]: true});
      tasks[day] = dayObj;

      const currentCoins = isNaN(data.coins) ? 0 : Number(data.coins);
      const newCoins = currentCoins + 1; // 1 ÙƒÙˆÙŠÙ† Ù„ÙƒÙ„ Ù…Ù‡Ù…Ø©
      
      await updateDoc(userDocRef, {
        tasks,
        coins: newCoins,
        lastTaskAt: Date.now(),
        date: todayKey(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
        lastOutline: serverTimestamp(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        updatedAt: serverTimestamp(),
      });
      
      await loadAndSetUI();
      return {ok:true};
    }

    // Ù…ÙƒØ§ÙØ£Ø© ÙŠÙˆÙ…ÙŠØ© (Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© 0.2 Ø¥Ù„Ù‰ 1.5) â€” ØªØªØ·Ù„Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ£ØªÙ… Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø§Ù„ÙŠÙˆÙ…
    function randomDaily(){
      const min = 0.2, max = 1.5;
      return +(Math.random()*(max-min)+min).toFixed(2);
    }

    async function claimDaily(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const daily = Object.assign({}, data.daily||{});

      if (daily[day]?.claimed) throw new Error('Ø§Ø³ØªÙ„Ù…Øª Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙØ¹Ù„');
      if (lvls < 1) throw new Error('Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ù‹Ø§');
      if (tasksCount < 1) throw new Error('Ø£ÙƒÙ…Ù„ Ù…Ù‡Ù…Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£ÙˆÙ„Ù‹Ø§');

      const amount = randomDaily();
      const currentCoins = isNaN(data.coins) ? 0 : Number(data.coins);
      const newCoins = currentCoins + amount;
      daily[day] = { claimed: true, amount };

      await updateDoc(userDocRef, {
        coins: newCoins,
        daily,
        date: todayKey(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§Ø±ÙŠØ®
        lastOutline: serverTimestamp(), // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ
        updatedAt: serverTimestamp(),
      });

      await loadAndSetUI();
      return amount;
    }

    // Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.getElementById('watchAdBtn').addEventListener('click', async () => {
      // Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø£ØµÙ„ÙŠØŒ Ù„ÙƒÙ† Ù†Ø¶ÙŠÙ Ø·Ø¨Ù‚Ø© "Ù„ÙŠÙÙ„" ÙÙˆÙ‚Ù‡
      try {
        const can = await canGainLevel();
        if (!can.ok) { 
          setStatus(can.reason, 'err'); 
          return; 
        }
        
        const res = await window.AdController.show();
        if (res && res.done && !res.error) {
          await gainLevel();
          setStatus('ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ âœ”', 'ok');
        } else {
          setStatus('Ù„Ù… ØªÙƒØªÙ…Ù„ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©', 'err');
        }
      } catch (e) {
        setStatus(e.message || 'Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„', 'err');
      }
    });

    taskButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        try {
          await completeTaskOnce(btn.dataset.taskId);
          setStatus('Ø£ÙÙ†Ø¬Ø²Øª Ø§Ù„Ù…Ù‡Ù…Ø© +1 ÙƒÙˆÙŠÙ†', 'ok');
        } catch (e) {
          setStatus(e.message || 'ØªØ¹Ø°Ø± Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©', 'err');
        } finally { 
          btn.disabled = false; 
        }
      });
    });

    dailyBtn.addEventListener('click', async ()=>{
      dailyStatus.classList.add('hidden');
      try {
        const amount = await claimDaily();
        dailyStatus.innerHTML = `<i class="fas fa-check-circle"></i> ØªÙ… Ø¥ÙŠØ¯Ø§Ø¹ ${amount} ÙƒÙˆÙŠÙ† ğŸ‰`;
        dailyStatus.className = 'pill ok';
        dailyStatus.classList.remove('hidden');
      } catch (e) {
        dailyStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${e.message || 'ØªØ¹Ø°Ø± ØµØ±Ù Ø§Ù„Ù…ÙƒØ§ÙØ£Ø©'}`;
        dailyStatus.className = 'pill err';
        dailyStatus.classList.remove('hidden');
      }
    });

    // 3) ØªØ³Ø¬ÙŠÙ„ Ù…Ø¬Ù‡ÙˆÙ„ Ø«Ù… ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      const data = await ensureUser();
      setUI(data);
      displayUserInfo(data);
    });

  </script>
</body>
</html>
