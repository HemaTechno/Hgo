
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>مشاهدة إعلان — AdsGram x Telegram Mini App</title>
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- AdsGram SDK (vanilla JS) -->
  <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
  <style>
    :root {
      --bg: #0f1115;
      --card: #151922;
      --text: #e8ebf0;
      --muted: #a8b3c7;
      --accent: #22c55e;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
      display: grid; place-items: center;
    }
    .wrap { width: min(680px, 92vw); }
    .card {
      background: var(--card); border-radius: 20px; padding: 22px; box-shadow: 0 10px 30px rgb(0 0 0 / 30%);
    }
    h1 { margin: 0 0 8px; font-size: 22px; }
    p { margin: 0 0 16px; color: var(--muted); line-height: 1.6; }
    .actions { display: flex; gap: 10px; align-items: center; }
    button {
      appearance: none; border: 0; border-radius: 14px; padding: 12px 18px; font-weight: 700; cursor: pointer;
    }
    #watchAdBtn { background: var(--accent); color: #052e13; }
    #watchAdBtn[disabled] { opacity: .6; cursor: not-allowed; }
    .pill { padding: 8px 12px; border-radius: 999px; font-size: 13px; }
    .pill.ok { background: rgb(34 197 94 / 18%); color: #6ee7b7; }
    .pill.err { background: rgb(239 68 68 / 15%); color: #fecaca; }
    .hidden { display: none; }
    a.cta { color: var(--accent); text-decoration: none; font-weight: 700; }
    .footer { margin-top: 14px; font-size: 12px; color: var(--muted); opacity: .8; }
    .grid { display: grid; gap: 12px; }
    .two { grid-template-columns: 1fr 1fr; }
    .stat { background: #0e1220; border-radius: 14px; padding: 12px; }
    .stat h3 { margin: 0 0 6px; font-size: 14px; color: #a8b3c7; font-weight: 600; }
    .stat .v { font-size: 20px; font-weight: 800; }
    .task { display:flex; justify-content: space-between; align-items:center; padding:10px; border-radius:12px; background:#0e1220; }
    .task small { color: var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>شاهد إعلان واحصل على المكافأة</h1>
      <p>بالضغط على الزر بالأسفل سيتم عرض إعلان <strong>AdsGram</strong>. بعد المشاهدة حتى النهاية سيتم فتح المكافأة.</p>
      <div class="actions">
        <button id="watchAdBtn">▶️ شاهد الإعلان</button>
        <span id="status" class="pill hidden"></span>
      </div>
      <div id="reward" class="hidden" style="margin-top:14px">
        <p class="pill ok">✅ تهانينا! تم فتح المكافأة.</p>
        <!-- عدّل الرابط التالي بما يناسبك -->
        <p><a id="rewardLink" class="cta" href="#" target="_blank" rel="noopener">افتح المكافأة الآن</a></p>
      </div>
      <div id="errorBox" class="hidden" style="margin-top:14px">
        <p class="pill err">⚠️ حدث خطأ أثناء عرض الإعلان. حاول مرة أخرى لاحقًا.</p>
      </div>
      <div class="footer">Mini App يعمل داخل تليجرام. لو فتحته من المتصفح قد لا تظهر الإعلانات.</div>

      <hr style="border:0;border-top:1px solid #222; margin:18px 0; opacity:.5">

      <!-- لوحة الإحصائيات -->
      <div class="grid two">
        <div class="stat">
          <h3>الرصيد (Coins)</h3>
          <div class="v" id="coins">0</div>
        </div>
        <div class="stat">
          <h3>مستوى اليوم</h3>
          <div class="v"><span id="levelToday">0</span>/20</div>
        </div>
        <div class="stat">
          <h3>انتظار بين المستويات</h3>
          <div class="v" id="cooldown">جاهز</div>
        </div>
        <div class="stat">
          <h3>مهام اليوم</h3>
          <div class="v" id="tasksToday">0</div>
        </div>
      </div>

      <div style="margin-top:14px" class="grid">
        <button id="claimDailyBtn">🎁 الحصول على المكافأة اليومية</button>
        <span id="dailyStatus" class="pill hidden"></span>
      </div>

      <!-- قائمة مهام تجريبية -->
      <div style="margin-top:14px" class="grid">
        <div class="task">
          <div>
            <div>مهمة رقم 1</div>
            <small>يكسب 1 كوين — يتطلب مشاهدة إعلان</small>
          </div>
          <button data-task-id="task1" class="taskBtn">تنفيذ</button>
        </div>
        <div class="task">
          <div>
            <div>مهمة رقم 2</div>
            <small>يكسب 1 كوين — يتطلب مشاهدة إعلان</small>
          </div>
          <button data-task-id="task2" class="taskBtn">تنفيذ</button>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ===== Telegram Mini App bootstrapping =====
    window.tg = window.Telegram ? window.Telegram.WebApp : null;
    const tg = window.tg;
    if (tg) {
      tg.ready();
      try { tg.expand(); } catch (e) {}
      // موازنة الألوان حسب ثيم تليجرام
      const theme = tg.themeParams || {};
      if (theme.bg_color) document.body.style.background = theme.bg_color;
    }

    // ===== AdsGram init =====
    const blockId = 'int-14053'; // <-- blockId الذي أعطيتني إياه
    let AdController = null;
    try {
      window.AdController = AdController = window.Adsgram.init({ blockId });
    } catch (e) {
      console.warn('AdsGram init failed:', e);
    }

    // ===== UI helpers =====
    const btn = document.getElementById('watchAdBtn');
    const status = document.getElementById('status');
    const reward = document.getElementById('reward');
    const rewardLink = document.getElementById('rewardLink');
    const errorBox = document.getElementById('errorBox');

    function setStatus(text, kind) {
      status.textContent = text;
      status.className = `pill ${kind || ''}`;
      status.classList.remove('hidden');
    }
    function clearStatus() {
      status.classList.add('hidden');
    }

    // عدّل رابط المكافأة كما تريد (مثلاً رابط تنزيل أو صفحة خاصة)
    rewardLink.href = 'https://t.me/';

    // ===== Show ad on click (Rewarded logic) =====
    btn.addEventListener('click', async () => {
      clearStatus(); errorBox.classList.add('hidden'); reward.classList.add('hidden');
      btn.disabled = true;
      if (tg && tg.HapticFeedback) {
        try { tg.HapticFeedback.impactOccurred('light'); } catch (e) {}
      }
      if (!AdController || !AdController.show) {
        setStatus('المكوّن غير جاهز', 'err');
        btn.disabled = false; return;
      }
      setStatus('جارٍ تحميل الإعلان…', '');
      try {
        const result = await AdController.show();
        // في rewarded: يتحقق done && !error عندما يشاهد المستخدم حتى النهاية
        // في interstitial: تتحقق حتى لو أغلق الإعلان — اعمل منطقك حسب نوع البلوك
        if (result && result.done && !result.error) {
          setStatus('تمت المشاهدة ✔', 'ok');
          reward.classList.remove('hidden');
          if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('success'); } catch (e) {}
        } else {
          setStatus('لم تكتمل المشاهدة', 'err');
        }
      } catch (err) {
        console.warn('Ads error', err);
        errorBox.classList.remove('hidden');
        setStatus('خطأ أثناء التشغيل', 'err');
        if (tg && tg.HapticFeedback) try { tg.HapticFeedback.notificationOccurred('error'); } catch (e) {}
      } finally {
        btn.disabled = false;
      }
    });

    // تحذير خفيف عند التشغيل خارج تليجرام (لأغراض الاختبار)
    if (!tg) {
      console.info('يُفضَّل فتح هذا الملف داخل تليجرام عبر زر web_app في البوت.');
    }
  </script>

  <!-- Firebase + منطق التخزين (Module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // 1) ضع إعدادات Firebase الخاصة بك هنا
    const firebaseConfig = {
      // TODO: الصق مفاتيح مشروعك هنا
      apiKey: "",
      authDomain: "",
      projectId: "",
      storageBucket: "",
      messagingSenderId: "",
      appId: ""
    };

    // 2) التهيئة
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Helpers للتواريخ حسب القاهرة
    const tzOffsetMs = new Date().getTimezoneOffset() * 60000; // سنستخدم تاريخ المتصفح؛ يمكن تعويضه بالسيرفر لاحقًا
    function todayKey() {
      const d = new Date(Date.now());
      // مفتاح اليوم YYYY-MM-DD
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${dd}`;
    }

    // مراجع عناصر الواجهة
    const coinsEl = document.getElementById('coins');
    const levelTodayEl = document.getElementById('levelToday');
    const cooldownEl = document.getElementById('cooldown');
    const tasksTodayEl = document.getElementById('tasksToday');
    const dailyBtn = document.getElementById('claimDailyBtn');
    const dailyStatus = document.getElementById('dailyStatus');

    const taskButtons = Array.from(document.querySelectorAll('.taskBtn'));

    // بيانات المستخدم
    let uid = null;          // uid من Firebase (مجهول)
    let tgId = null;         // Telegram user id
    let userDocRef = null;

    // جلب معرّف المستخدم من تليجرام Mini App
    function getTelegramId() {
      try {
        const u = window.tg?.initDataUnsafe?.user;
        return u?.id ? String(u.id) : null;
      } catch (e) { return null; }
    }

    // إنشاء / تحديث مستند المستخدم
    async function ensureUser() {
      tgId = getTelegramId();
      if (!tgId) {
        console.warn('لم يتم التقاط معرف تليجرام — افتح الميني آب داخل تليجرام.');
      }
      userDocRef = doc(db, 'users', tgId || 'debug-guest');
      const snap = await getDoc(userDocRef);
      const base = {
        tgId: tgId || null,
        coins: 0,
        levels: {},             // map: dayKey -> count
        lastLevelAt: 0,         // timestamp ms
        tasks: {},              // map: dayKey -> {count: number}
        lastTaskAt: 0,
        daily: {},              // map: dayKey -> {claimed: bool, amount: number}
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      };
      if (!snap.exists()) {
        await setDoc(userDocRef, base);
        return base;
      } else {
        return snap.data();
      }
    }

    function setUI(data){
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const cdSec = Math.max(0, Math.ceil(( (data.lastLevelAt||0) + 60*1000 - Date.now() )/1000));
      coinsEl.textContent = Number(data.coins||0).toFixed(2).replace(/\.00$/, '');
      levelTodayEl.textContent = levelCount;
      cooldownEl.textContent = cdSec>0 ? `${cdSec} ثانية` : 'جاهز';
      tasksTodayEl.textContent = tasksCount;
    }

    async function loadAndSetUI(){
      const snap = await getDoc(userDocRef);
      if (snap.exists()) setUI(snap.data());
    }

    // منطق المستويات (الإعلانات)
    async function canGainLevel(){
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const day = todayKey();
      const levelCount = (data.levels && data.levels[day]) || 0;
      const lastAt = data.lastLevelAt || 0;
      const onCooldown = (Date.now() - lastAt) < 60*1000; // 1 دقيقة
      if (levelCount >= 20) return {ok:false, reason:'تم بلوغ 20 لفل اليوم'};
      if (onCooldown) return {ok:false, reason:'انتظر دقيقة بين المستويات'};
      return {ok:true, data};
    }

    async function gainLevel(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = Object.assign({}, data.levels||{});
      lvls[day] = (lvls[day]||0)+1;
      await updateDoc(userDocRef, {
        levels: lvls,
        lastLevelAt: Date.now(),
        updatedAt: serverTimestamp(),
      });
      await loadAndSetUI();
    }

    // منطق المهام (كل مهمة = 1 كوين وتتطلب إعلان)
    async function completeTaskOnce(taskId){
      // شغل إعلان أولاً
      if (!window.AdController || !window.AdController.show) throw new Error('Ads not ready');
      const r = await window.AdController.show();
      if (!(r && r.done && !r.error)) throw new Error('لم تكتمل مشاهدة الإعلان');

      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const tasks = Object.assign({} , data.tasks||{});
      const dayObj = Object.assign({count:0, completed: {}}, tasks[day]||{});
      if (dayObj.completed && dayObj.completed[taskId]) {
        throw new Error('أتممت هذه المهمة اليوم بالفعل');
      }
      dayObj.count = (dayObj.count||0)+1;
      dayObj.completed = Object.assign({}, dayObj.completed, {[taskId]: true});
      tasks[day] = dayObj;

      const newCoins = Number(data.coins||0) + 1; // 1 كوين لكل مهمة
      await updateDoc(userDocRef, {
        tasks,
        coins: newCoins,
        lastTaskAt: Date.now(),
        updatedAt: serverTimestamp(),
      });
      await loadAndSetUI();
      return {ok:true};
    }

    // مكافأة يومية (عشوائية 0.2 إلى 1.5) — تتطلب أن يكون المستخدم شاهد إعلانًا واحدًا على الأقل وأتم مهمة واحدة على الأقل اليوم
    function randomDaily(){
      const min = 0.2, max = 1.5;
      return +(Math.random()*(max-min)+min).toFixed(2);
    }

    async function claimDaily(){
      const day = todayKey();
      const snap = await getDoc(userDocRef);
      const data = snap.data() || {};
      const lvls = (data.levels && data.levels[day]) || 0;
      const tasksCount = (data.tasks && data.tasks[day]?.count) || 0;
      const daily = Object.assign({}, data.daily||{});

      if (daily[day]?.claimed) throw new Error('استلمت مكافأة اليوم بالفعل');
      if (lvls < 1) throw new Error('شاهد إعلانًا واحدًا على الأقل أولًا');
      if (tasksCount < 1) throw new Error('أكمل مهمة واحدة على الأقل أولًا');

      const amount = randomDaily();
      const newCoins = Number(data.coins||0) + amount;
      daily[day] = { claimed: true, amount };

      await updateDoc(userDocRef, {
        coins: newCoins,
        daily,
        updatedAt: serverTimestamp(),
      });

      await loadAndSetUI();
      return amount;
    }

    // ربط الأزرار
    document.getElementById('watchAdBtn').addEventListener('click', async () => {
      // لا نغيّر منطق الإعلان الأصلي، لكن نضيف طبقة "ليفل" فوقه
      try {
        const can = await canGainLevel();
        if (!can.ok) { setStatus(can.reason, 'err'); return; }
        const res = await window.AdController.show();
        if (res && res.done && !res.error) {
          await gainLevel();
          setStatus('تم رفع المستوى ✔', 'ok');
        } else {
          setStatus('لم تكتمل المشاهدة', 'err');
        }
      } catch (e) {
        setStatus(e.message || 'خطأ أثناء التشغيل', 'err');
      }
    });

    taskButtons.forEach(btn => {
      btn.addEventListener('click', async () => {
        btn.disabled = true;
        try {
          await completeTaskOnce(btn.dataset.taskId);
          setStatus('أُنجزت المهمة +1 كوين', 'ok');
        } catch (e) {
          setStatus(e.message || 'تعذر إتمام المهمة', 'err');
        } finally { btn.disabled = false; }
      });
    });

    dailyBtn.addEventListener('click', async ()=>{
      dailyStatus.classList.add('hidden');
      try {
        const amount = await claimDaily();
        dailyStatus.textContent = `تم إيداع ${amount} كوين 🎉`;
        dailyStatus.className = 'pill ok';
        dailyStatus.classList.remove('hidden');
      } catch (e) {
        dailyStatus.textContent = e.message || 'تعذر صرف المكافأة';
        dailyStatus.className = 'pill err';
        dailyStatus.classList.remove('hidden');
      }
    });

    // 3) تسجيل مجهول ثم تهيئة بيانات المستخدم
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      uid = user.uid;
      const data = await ensureUser();
      setUI(data);
    });

  </script>
</body>
</html>
