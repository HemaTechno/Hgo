<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mini App Coins</title>

  <!-- Telegram WebApp SDK -->
<script src='//libtl.com/sdk.js' data-zone='9747739' data-sdk='show_9747739'></script>
  <!-- Firebase SDK (Compat Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ÙƒÙˆØ¯) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- Monetag Tag (Ø§Ø³ØªØ®Ø¯Ù…Øª Ø±Ù‚Ù… Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø°ÙŠ Ø£Ø±Ø³Ù„ØªÙ‡) -->
  <script src="https://js.monetag.com/9747739/tag.min.js"></script>

  <style>
    :root { --bg:#0d1117; --card:#161b22; --txt:#fff; --muted:#9ca3af; --acc:#0088cc; }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: system-ui, Arial, sans-serif;
      background: var(--bg); color: var(--txt); display: flex; flex-direction: column; height: 100vh;
    }
    header {
      padding: 14px 18px; background: var(--card); border-bottom: 1px solid #222;
      display: flex; align-items: center; justify-content: space-between;
    }
    header h1 { margin: 0; font-size: 18px; }
    .coins-pill {
      background: #0b2530; border: 1px solid #103645; padding: 6px 10px; border-radius: 999px; font-weight: 700;
    }
    main { flex: 1; padding: 16px; overflow-y: auto; }
    .card {
      background: var(--card); border: 1px solid #1f2937; border-radius: 14px; padding: 14px; margin-bottom: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,.25);
    }
    .card h3 { margin: 0 0 8px; font-size: 16px; }
    .card p { margin: 0 0 10px; color: var(--muted); }
    .btn {
      display: inline-block; background: var(--acc); color: #fff; border: 0; border-radius: 12px;
      padding: 10px 16px; font-weight: 700; cursor: pointer; font-size: 15px;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    nav {
      display: grid; grid-template-columns: repeat(3,1fr); gap: 0;
      background: var(--card); border-top: 1px solid #222;
    }
    nav button {
      appearance: none; background: transparent; border: 0; color: var(--muted);
      padding: 12px 6px; font-size: 15px; cursor: pointer; font-weight: 700;
    }
    nav button.active { color: #fff; border-top: 2px solid var(--acc); }
    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .task-line { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .small { font-size: 13px; color: var(--muted); }
  </style>
</head>
<body>
  <header>
    <h1>Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆÙŠÙ†Ø§Øª</h1>
    <div class="coins-pill">ğŸª™ <span id="coins">0</span></div>
  </header>

  <main id="content"></main>

  <nav>
    <button id="homeBtn" class="active">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <button id="tasksBtn">ğŸ¯ Ø§Ù„Ù…Ù‡Ø§Ù…</button>
    <button id="profileBtn">ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</button>
  </nav>

  <script>
    // ---------- Telegram User ----------
    const tg = window.Telegram?.WebApp;
    tg?.expand();
    const TELEGRAM_USER_ID = tg?.initDataUnsafe?.user?.id?.toString() || "guest"; // Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ·ÙˆÙŠØ±

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const usersCol = db.collection("users");
    const userRef = usersCol.doc(TELEGRAM_USER_ID);

    // ---------- State ----------
    const content = document.getElementById("content");
    const coinsEl = document.getElementById("coins");
    let coins = 0;
    let adLock = false; // Ù…Ù†Ø¹ Ø§Ù„Ø³Ø¨Ø§Ù… Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† Firestore
    async function loadCoins() {
      const snap = await userRef.get();
      if (!snap.exists) {
        await userRef.set({ coins: 0, lastUpdate: Date.now(), scriptsUnlocked: [] });
        coins = 0;
      } else {
        coins = Number(snap.data().coins || 0);
      }
      coinsEl.textContent = coins;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Firestore
    async function addCoins(amount) {
      coins += amount;
      coinsEl.textContent = coins;
      await userRef.set({ coins, lastUpdate: Date.now() }, { merge: true });
    }

    // ---------- ØµÙØ­Ø§Øª ----------
    function setPage(page) {
      document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
      if (page === "home") {
        document.getElementById("homeBtn").classList.add("active");
        content.innerHTML = `
          <div class="card">
            <h3>ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ!</h3>
            <p class="small">Ø§Ø¨Ø¯Ø£ Ø¨Ø¬Ù…Ø¹ Ø§Ù„ÙƒÙˆÙŠÙ†Ø§Øª Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø«Ù… Ø§Ø¹Ø±Ø¶ Ø±ØµÙŠØ¯Ùƒ Ù…Ù† "Ø­Ø³Ø§Ø¨ÙŠ".</p>
          </div>
          <div class="card">
            <h3>âš¡ ØªÙ„Ù…ÙŠØ­</h3>
            <p class="small">ÙŠÙ…ÙƒÙ†Ùƒ ÙƒØ³Ø¨ ÙƒÙˆÙŠÙ† Ø¨Ù…Ø´Ø§Ù‡Ø¯Ø© Ø¥Ø¹Ù„Ø§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„ÙŠÙØ¶Ø§Ù Ø§Ù„Ø±ØµÙŠØ¯.</p>
          </div>
        `;
      }
      if (page === "tasks") {
        document.getElementById("tasksBtn").classList.add("active");
        content.innerHTML = `
          <div class="card">
            <div class="task-line">
              <div>
                <h3>ğŸ¥ Ø´Ø§Ù‡Ø¯ Ø¥Ø¹Ù„Ø§Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</h3>
                <div class="small">ØªÙƒØ§ÙØ¤: +1 ÙƒÙˆÙŠÙ† â€” ÙŠÙØ¶Ø§Ù Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¹Ø±Ø¶.</div>
              </div>
              <button class="btn" id="watchAdBtn">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù†</button>
            </div>
          </div>

          <div class="card">
            <div class="task-line">
              <div>
                <h3>ğŸŒ Ø²ÙŠØ§Ø±Ø© Ø±Ø§Ø¨Ø·</h3>
                <div class="small">Ø§Ø¯Ø®Ù„ Ù„Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ø¯Ø© 10 Ø«ÙˆØ§Ù†ÙŠ Ø«Ù… Ø§Ø±Ø¬Ø¹ Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ +2 ÙƒÙˆÙŠÙ†.</div>
              </div>
              <button class="btn" id="visitBtn">Ø§Ø°Ù‡Ø¨</button>
            </div>
          </div>
        `;

        // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù‡Ø§Ù…
        document.getElementById("watchAdBtn").addEventListener("click", watchAdTask);
        document.getElementById("visitBtn").addEventListener("click", visitLinkTask);
      }
      if (page === "profile") {
        document.getElementById("profileBtn").classList.add("active");
        content.innerHTML = `
          <div class="card">
            <h3>ğŸ‘¤ Ø­Ø³Ø§Ø¨ÙŠ</h3>
            <p>ğŸª™ Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: <b>${coins}</b></p>
            <p class="small">Ø§Ù„Ù…Ø¹Ø±Ù‘Ù: ${TELEGRAM_USER_ID}</p>
            <div class="row">
              <button class="btn" id="refreshBtn">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯</button>
              <button class="btn" id="sendToBot">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¨ÙˆØª</button>
            </div>
          </div>
        `;
        document.getElementById("refreshBtn").addEventListener("click", loadCoins);
        document.getElementById("sendToBot").addEventListener("click", () => {
          tg?.sendData?.(JSON.stringify({ type: "balance", coins }));
          tg?.showPopup?.({ title: "ØªÙ…", message: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±ØµÙŠØ¯Ùƒ Ù„Ù„Ø¨ÙˆØª.", buttons: [{type:"ok"}] });
        });
      }
    }

    // ---------- Ù…Ù‡Ù…Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Monetag) ----------
    async function watchAdTask() {
      if (adLock) return;
      adLock = true;
      const btn = document.getElementById("watchAdBtn");
      btn.disabled = true;

      // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
      try {
        show_9747739({
          type: 'inApp',
          inAppSettings: {
            frequency: 1,   // Ø¥Ø¹Ù„Ø§Ù† ÙˆØ§Ø­Ø¯ ÙƒÙ„ Ù…Ø±Ø©
            capping: 0.1,   // ÙƒÙ„ 6 Ø¯Ù‚Ø§Ø¦Ù‚ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
            interval: 30,   // ÙØ§ØµÙ„Ø© 30 Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† Ø¹Ø±ÙˆØ¶ Ø§Ù„Ø¬Ù„Ø³Ø©
            timeout: 5,     // ÙŠØ¨Ø¯Ø£ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†ÙŠ
            everyPage: false
          }
        });
      } catch(e){ /* ØªØ¬Ø§Ù‡Ù„ Ø£ÙŠ Ø®Ø·Ø£ ÙÙŠ Ø³ÙƒØ±Ø¨Øª Monetag */ }

      // Ù…Ù† ØºÙŠØ± Callback Ø±Ø³Ù…ÙŠ Ù…Ù† MonetagØŒ Ù†Ø¹ØªÙ…Ø¯ Ù…Ø¤Ù‚Øª Ø£Ù…Ø§Ù†
      // Ø²ÙˆÙ‘Ø¯Ù‡/Ù‚Ù„Ù‘Ù„Ù‡ Ø­Ø³Ø¨ Ø·ÙˆÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ¹Ù„ÙŠ
      const ASSUMED_DURATION_MS = 12000; // 12 Ø«Ø§Ù†ÙŠØ©
      setTimeout(async () => {
        await addCoins(1);
        tg?.showPopup?.({
          title: "Ù…Ù…ØªØ§Ø²!",
          message: "âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© 1 ÙƒÙˆÙŠÙ† Ø¨Ø¹Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†.",
          buttons: [{ type: "ok" }]
        });
        btn.disabled = false;
        adLock = false;
      }, ASSUMED_DURATION_MS);
    }

    // ---------- Ù…Ù‡Ù…Ø© Ø²ÙŠØ§Ø±Ø© Ø±Ø§Ø¨Ø· ----------
    function visitLinkTask() {
      const url = "https://example.com/"; // ØºÙŠÙ‘Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù…Ù‡Ù…Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©
      const WAIT_MS = 10000; // 10 Ø«ÙˆØ§Ù†ÙŠ
      tg?.openLink?.(url, { try_instant_view: false });

      const btn = document.getElementById("visitBtn");
      btn.disabled = true;
      setTimeout(async () => {
        await addCoins(2);
        tg?.showPopup?.({
          title: "ØªÙ…Øª Ø§Ù„Ù…Ù‡Ù…Ø©",
          message: "âœ… Ø­ØµÙ„Øª Ø¹Ù„Ù‰ +2 ÙƒÙˆÙŠÙ† Ø¨Ø¹Ø¯ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ø±Ø§Ø¨Ø·.",
          buttons: [{ type: "ok" }]
        });
        btn.disabled = false;
      }, WAIT_MS);
    }

    // ---------- ØªÙ†Ù‚Ù‘Ù„ ----------
    document.getElementById("homeBtn").addEventListener("click", () => setPage("home"));
    document.getElementById("tasksBtn").addEventListener("click", () => setPage("tasks"));
    document.getElementById("profileBtn").addEventListener("click", () => setPage("profile"));

    // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ÙŠ
    loadCoins().then(() => setPage("home"));
  </script>
</body>
</html>

