
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini App Coins</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- Monetag SDK -->
  <script src="//libtl.com/sdk.js" data-zone="9747739" data-sdk="show_9747739" defer></script>

  <!-- Telegram SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-gray-900 text-white flex flex-col min-h-screen">

  <!-- Header -->
  <header class="bg-gray-800 p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">🚀 Mini App</h1>
    <div id="coinsBox" class="bg-blue-600 px-4 py-1 rounded-full">🪙 0</div>
  </header>

  <!-- Pages -->
  <main id="pageHome" class="flex-1 p-6 text-center">
    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg">
      <h2 class="text-lg mb-2">رصيدك الحالي</h2>
      <p id="coins" class="text-4xl font-bold">0 🪙</p>
    </div>
  </main>

  <main id="pageTasks" class="hidden flex-1 p-6 text-center">
    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg space-y-4">
      <h2 class="text-lg">🎥 المهام اليومية</h2>
      <div class="w-full bg-gray-700 rounded-full h-2">
        <div id="progressBar" class="bg-blue-500 h-2 rounded-full w-0"></div>
      </div>
      <p id="taskInfo">0 / 100 إعلان اليوم</p>
      <button id="watchAdBtn" class="bg-blue-600 px-4 py-2 rounded-xl">🎥 شاهد إعلان</button>
    </div>
  </main>

  <main id="pageProfile" class="hidden flex-1 p-6 text-center">
    <div class="bg-gray-800 rounded-2xl p-6 shadow-lg space-y-2">
      <h2 class="text-lg mb-4">👤 حسابك</h2>
      <p id="userId">Telegram ID: -</p>
      <p>Coins: <span id="coinsProfile">0</span></p>
      <p>Tasks Today: <span id="tasksProfile">0</span>/100</p>
    </div>
  </main>

  <!-- Bottom Nav -->
  <nav class="flex justify-around bg-gray-800 py-3 border-t border-gray-700">
    <button onclick="showPage('home')" class="text-blue-400">🏠</button>
    <button onclick="showPage('tasks')" class="text-gray-400">🎥</button>
    <button onclick="showPage('profile')" class="text-gray-400">👤</button>
  </nav>

<script>
  // ✅ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
    authDomain: "hhhhhh-d4fb8.firebaseapp.com",
    databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
    projectId: "hhhhhh-d4fb8",
    storageBucket: "hhhhhh-d4fb8.appspot.com",
    messagingSenderId: "24512338206",
    appId: "1:24512338206:web:dfe045db59bd3434a2110f",
    measurementId: "G-HD4R7GNQ5H"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Telegram User
  const tg = window.Telegram.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id?.toString() || "guest";
  document.getElementById("userId").textContent = "Telegram ID: " + userId;

  // User Data
  let coins = 0;
  let tasksToday = 0;
  const DAILY_LIMIT = 100;

  // Load User
  async function loadUser() {
    const today = new Date().toISOString().split("T")[0];
    const ref = db.collection("users").doc(userId);
    const docSnap = await ref.get();
    if (!docSnap.exists) {
      await ref.set({ coins: 0, tasksToday: 0, lastTaskDate: today });
      coins = 0; tasksToday = 0;
    } else {
      const data = docSnap.data();
      coins = data.coins;
      if (data.lastTaskDate !== today) {
        tasksToday = 0;
        await ref.update({ tasksToday: 0, lastTaskDate: today });
      } else {
        tasksToday = data.tasksToday;
      }
    }
    updateUI();
  }

  // Update UI
  function updateUI() {
    document.getElementById("coins").textContent = coins + " 🪙";
    document.getElementById("coinsBox").textContent = "🪙 " + coins;
    document.getElementById("coinsProfile").textContent = coins;
    document.getElementById("tasksProfile").textContent = tasksToday;
    document.getElementById("taskInfo").textContent = tasksToday + "/" + DAILY_LIMIT + " إعلان اليوم";
    document.getElementById("progressBar").style.width = (tasksToday/DAILY_LIMIT*100)+"%";
  }

  // Watch Ad
  document.getElementById("watchAdBtn").addEventListener("click", async () => {
    if (tasksToday >= DAILY_LIMIT) {
      return alert("❌ وصلت الحد اليومي");
    }

    const btn = document.getElementById("watchAdBtn");
    btn.disabled = true;
    btn.textContent = "⏳ الإعلان قيد العرض...";

    // 📌 الإعلان مش هيظهر غير هنا عند الضغط على الزر
    if (typeof window.show_9747739 === "function") {
      window.show_9747739({
        type: 'inApp',
        inAppSettings: { interval: 5 }
      });
    }

    // بعد 30 ثانية (مدة المشاهدة)
    setTimeout(async () => {
      coins++;
      tasksToday++;
      await db.collection("users").doc(userId).set({
        coins,
        tasksToday,
        lastTaskDate: new Date().toISOString().split("T")[0]
      }, { merge: true });
      updateUI();
      alert("✅ مبروك! كسبت 1 كوين بعد مشاهدة الإعلان");
      btn.disabled = false;
      btn.textContent = "🎥 شاهد إعلان";
    }, 30000);
  });

  // Pages
  function showPage(page) {
    document.querySelectorAll("main").forEach(m => m.classList.add("hidden"));
    document.getElementById("page"+page.charAt(0).toUpperCase()+page.slice(1)).classList.remove("hidden");
    document.querySelectorAll("nav button").forEach(btn => btn.classList.replace("text-blue-400","text-gray-400"));
    document.querySelector(`nav button[onclick="showPage('${page}')"]`).classList.replace("text-gray-400","text-blue-400");
  }

  loadUser();
</script>

</body>
</html>

