import { useEffect, useState } from "react";
import { Progress } from "@/components/ui/progress";
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Home, PlayCircle, User, Coins, Sparkles, Trophy, Star } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { initializeApp } from "firebase/app";
import { getFirestore, doc, getDoc, setDoc } from "firebase/firestore";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
  authDomain: "hhhhhh-d4fb8.firebaseapp.com",
  databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
  projectId: "hhhhhh-d4fb8",
  storageBucket: "hhhhhh-d4fb8.appspot.com",
  messagingSenderId: "24512338206",
  appId: "1:24512338206:web:dfe045db59bd3434a2110f",
  measurementId: "G-HD4R7GNQ5H"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

export default function MiniApp() {
  const tg = window.Telegram?.WebApp;
  const userId = tg?.initDataUnsafe?.user?.id?.toString() || "guest";

  const [page, setPage] = useState("home");
  const [coins, setCoins] = useState(0);
  const [tasksToday, setTasksToday] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const DAILY_LIMIT = 100;

  useEffect(() => {
    loadUser();
  }, []);

  async function loadUser() {
    setIsLoading(true);
    const today = new Date().toISOString().split("T")[0];
    const ref = doc(db, "users", userId);
    const snap = await getDoc(ref);
    let data;
    if (!snap.exists()) {
      data = { coins: 0, tasksToday: 0, lastTaskDate: today };
      await setDoc(ref, data);
    } else {
      data = snap.data();
      if (data.lastTaskDate !== today) {
        data.tasksToday = 0;
        data.lastTaskDate = today;
        await setDoc(ref, data, { merge: true });
      }
    }
    setCoins(data.coins);
    setTasksToday(data.tasksToday);
    setIsLoading(false);
  }

  async function watchAd() {
    if (tasksToday >= DAILY_LIMIT) return;

    setIsLoading(true);
    try {
      // Monetag Interstitial
      window.show_9747739({
        type: "inApp",
        inAppSettings: { frequency: 1, capping: 0.1, interval: 30, timeout: 3, everyPage: false },
      });
    } catch (e) {}

    // ุจุนุฏ ุงูุชูุงุก ุงูุฅุนูุงู ูุถูู ุงููููู
    setTimeout(async () => {
      const newCoins = coins + 1;
      const newTasks = tasksToday + 1;
      setCoins(newCoins);
      setTasksToday(newTasks);

      await setDoc(doc(db, "users", userId), {
        coins: newCoins,
        tasksToday: newTasks,
        lastTaskDate: new Date().toISOString().split("T")[0],
      }, { merge: true });

      setIsLoading(false);
      
      tg?.showPopup?.({
        title: "โ ูุจุฑูู!",
        message: "ูุณุจุช 1 ูููู ุจุนุฏ ูุดุงูุฏุฉ ุงูุฅุนูุงู.",
        buttons: [{ type: "ok" }],
      });
    }, 10000);
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 text-white flex flex-col">
      {/* Header */}
      <motion.header 
        initial={{ y: -20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        className="p-4 flex justify-between items-center bg-black/30 backdrop-blur-md border-b border-white/10"
      >
        <div className="flex items-center gap-2">
          <div className="p-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg">
            <Sparkles size={20} />
          </div>
          <h1 className="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">ุชุทุจูู ุงูููุงูุขุช</h1>
        </div>
        <div className="flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full border border-white/10">
          <Coins className="text-yellow-400" size={18} />
          <span className="font-semibold">{coins}</span>
        </div>
      </motion.header>

      {/* Pages */}
      <main className="flex-1 p-4 overflow-y-auto">
        <AnimatePresence mode="wait">
          {isLoading ? (
            <motion.div 
              key="loading"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="flex justify-center items-center h-64"
            >
              <div className="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-cyan-400"></div>
            </motion.div>
          ) : page === "home" ? (
            <motion.div 
              key="home"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              transition={{ duration: 0.3 }}
              className="space-y-4"
            >
              <Card className="bg-black/30 backdrop-blur-md border-white/10 overflow-hidden">
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2">
                    <div className="p-2 bg-gradient-to-r from-cyan-500 to-blue-500 rounded-lg">
                      <Coins className="text-white" size={20} />
                    </div>
                    <span>ุฑุตูุฏู ุงูุญุงูู</span>
                  </CardTitle>
                  <CardDescription className="text-white/70">
                    ุฅุฌูุงูู ุงูุนููุงุช ุงูุชู ุฌูุนุชูุง
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="flex justify-center items-baseline gap-2">
                    <span className="text-5xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                      {coins}
                    </span>
                    <span className="text-yellow-400">๐ช</span>
                  </div>
                </CardContent>
              </Card>

              <Card className="bg-black/30 backdrop-blur-md border-white/10">
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2">
                    <div className="p-2 bg-gradient-to-r from-green-500 to-emerald-500 rounded-lg">
                      <Trophy className="text-white" size={20} />
                    </div>
                    <span>ุฅุญุตุงุฆูุงุช ุงูููู</span>
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex justify-between items-center">
                    <span className="text-white/80">ุงูููุงู ุงูููุชููุฉ</span>
                    <span className="font-semibold">{tasksToday}/{DAILY_LIMIT}</span>
                  </div>
                  <Progress 
                    value={(tasksToday / DAILY_LIMIT) * 100} 
                    className="h-3 bg-white/10" 
                    indicatorClassName="bg-gradient-to-r from-green-500 to-emerald-500"
                  />
                  <Button 
                    onClick={() => setPage("tasks")} 
                    className="w-full bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600"
                  >
                    ุงุจุฏุฃ ุจูุณุจ ุงููุฒูุฏ
                  </Button>
                </CardContent>
              </Card>
            </motion.div>
          ) : page === "tasks" ? (
            <motion.div 
              key="tasks"
              initial={{ opacity: 0, x: 50 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -50 }}
              transition={{ duration: 0.3 }}
            >
              <Card className="bg-black/30 backdrop-blur-md border-white/10 overflow-hidden">
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2">
                    <div className="p-2 bg-gradient-to-r from-amber-500 to-orange-500 rounded-lg">
                      <PlayCircle className="text-white" size={20} />
                    </div>
                    <span>ุงูููุงู ุงูููููุฉ</span>
                  </CardTitle>
                  <CardDescription className="text-white/70">
                    ุดุงูุฏ ุงูุฅุนูุงูุงุช ูุงูุณุจ ุนููุงุช
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-6 text-center">
                  <div className="p-4 bg-black/20 rounded-xl border border-amber-500/30">
                    <div className="text-4xl mb-2">๐ฅ</div>
                    <h3 className="font-semibold">ุดุงูุฏ ุฅุนูุงููุง</h3>
                    <p className="text-white/70 text-sm mt-1">ูุงูุณุจ ุนููุฉ ูุงุญุฏุฉ ููู ุฅุนูุงู</p>
                  </div>
                  
                  <div className="space-y-3">
                    <div className="flex justify-between items-center text-sm">
                      <span className="text-white/80">ุงูุชูุฏู ุงููููู</span>
                      <span className="font-semibold">{tasksToday}/{DAILY_LIMIT}</span>
                    </div>
                    <Progress 
                      value={(tasksToday / DAILY_LIMIT) * 100} 
                      className="h-3 bg-white/10" 
                      indicatorClassName="bg-gradient-to-r from-amber-500 to-orange-500"
                    />
                  </div>
                  
                  <Button 
                    onClick={watchAd} 
                    disabled={tasksToday >= DAILY_LIMIT}
                    className="w-full py-3 text-lg font-semibold bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {tasksToday >= DAILY_LIMIT ? (
                      <span>ุงูุชูู ุงูุญุฏ ุงููููู - ุนูุฏ ุบุฏูุง!</span>
                    ) : (
                      <span>ุดุงูุฏ ุฅุนูุงููุง ูุงูุณุจ 1 ๐ช</span>
                    )}
                  </Button>
                </CardContent>
              </Card>
            </motion.div>
          ) : page === "profile" ? (
            <motion.div 
              key="profile"
              initial={{ opacity: 0, x: -50 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: 50 }}
              transition={{ duration: 0.3 }}
            >
              <Card className="bg-black/30 backdrop-blur-md border-white/10 overflow-hidden">
                <CardHeader className="pb-3">
                  <CardTitle className="flex items-center gap-2">
                    <div className="p-2 bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg">
                      <User className="text-white" size={20} />
                    </div>
                    <span>ูุนูููุงุช ุญุณุงุจู</span>
                  </CardTitle>
                  <CardDescription className="text-white/70">
                    ุชูุงุตูู ูููู ุงูุดุฎุตู ูุฃุฏุงุฆู
                  </CardDescription>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="p-4 bg-black/20 rounded-xl border border-purple-500/30">
                    <div className="flex items-center justify-center w-16 h-16 mx-auto mb-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500">
                      <User size={30} />
                    </div>
                    <h3 className="text-center font-semibold">ูุณุชุฎุฏู Telegram</h3>
                    <p className="text-center text-white/70 text-sm mt-1">ID: {userId}</p>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-3 bg-black/20 rounded-lg border border-cyan-500/30 text-center">
                      <div className="flex justify-center items-center gap-1 text-cyan-400">
                        <Coins size={18} />
                        <span className="font-bold text-lg">{coins}</span>
                      </div>
                      <p className="text-white/70 text-xs mt-1">ุงูุนููุงุช</p>
                    </div>
                    
                    <div className="p-3 bg-black/20 rounded-lg border border-emerald-500/30 text-center">
                      <div className="flex justify-center items-center gap-1 text-emerald-400">
                        <Star size={18} />
                        <span className="font-bold text-lg">{tasksToday}</span>
                      </div>
                      <p className="text-white/70 text-xs mt-1">ูููุงุช ุงูููู</p>
                    </div>
                  </div>
                  
                  <div className="pt-4 border-t border-white/10">
                    <h4 className="font-semibold mb-2">ุชูุฏูู ุงููููู</h4>
                    <Progress 
                      value={(tasksToday / DAILY_LIMIT) * 100} 
                      className="h-2 bg-white/10" 
                      indicatorClassName="bg-gradient-to-r from-purple-500 to-pink-500"
                    />
                    <p className="text-right text-xs text-white/70 mt-1">{tasksToday}/{DAILY_LIMIT} ({Math.round((tasksToday / DAILY_LIMIT) * 100)}%)</p>
                  </div>
                </CardContent>
              </Card>
            </motion.div>
          ) : null}
        </AnimatePresence>
      </main>

      {/* Bottom Navigation */}
      <motion.nav 
        initial={{ y: 20, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ delay: 0.2 }}
        className="flex justify-around items-center bg-black/30 backdrop-blur-md py-3 border-t border-white/10 mx-4 mb-2 rounded-xl"
      >
        {[
          { id: "home", icon: Home, label: "ุงูุฑุฆูุณูุฉ" },
          { id: "tasks", icon: PlayCircle, label: "ุงูููุงู" },
          { id: "profile", icon: User, label: "ุงูุญุณุงุจ" }
        ].map((item) => {
          const Icon = item.icon;
          const isActive = page === item.id;
          return (
            <button 
              key={item.id}
              onClick={() => setPage(item.id)}
              className={`flex flex-col items-center justify-center w-20 py-2 rounded-lg transition-all ${
                isActive 
                  ? "bg-gradient-to-r from-cyan-500/20 to-blue-500/20 text-cyan-400" 
                  : "text-white/60 hover:text-white"
              }`}
            >
              <Icon size={22} />
              <span className="text-xs mt-1">{item.label}</span>
              {isActive && (
                <motion.div 
                  layoutId="navIndicator"
                  className="w-1 h-1 bg-cyan-400 rounded-full mt-1"
                />
              )}
            </button>
          );
        })}
      </motion.nav>
    </div>
  );
}

