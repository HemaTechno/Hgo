<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <style>
    body {
      background: #f5f6fa;
      font-family: "Tahoma", sans-serif;
      color: #222;
      padding: 20px;
      margin: 0;
    }
    h1 { 
      text-align: center; 
      margin-bottom: 10px; 
      color: #2c3e50;
    }
    #status {
      text-align: center;
      font-weight: bold;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 20px;
      transition: all 0.3s ease;
    }
    .ok {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    #counter {
      text-align: center;
      font-weight: bold;
      margin-bottom: 25px;
      color: #007bff;
      font-size: 18px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: 0.3s;
      position: relative;
    }
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.12);
    }
    .card-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 12px;
      color: #666;
    }
    .card-id {
      background: #f0f2ff;
      padding: 2px 6px;
      border-radius: 5px;
    }
    .card-date {
      color: #888;
    }
    img {
      width: 100%;
      height: 180px;
      border-radius: 10px;
      margin-bottom: 10px;
      object-fit: cover;
      border: 1px solid #eee;
    }
    .info { 
      text-align: center; 
      margin-bottom: 12px; 
      width: 100%;
    }
    .info strong {
      display: block;
      margin-bottom: 5px;
      color: #2c3e50;
    }
    .info code {
      background: #f0f2ff;
      padding: 2px 6px;
      border-radius: 5px;
      font-size: 13px;
      direction: ltr;
      display: inline-block;
    }
    .btns { 
      display: flex; 
      justify-content: center; 
      gap: 10px; 
      width: 100%;
    }
    .btn {
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: #fff;
      font-size: 14px;
      transition: 0.2s;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .btn-accept { 
      background: #28a745; 
    }
    .btn-accept:hover { 
      background: #23923c; 
    }
    .btn-reject { 
      background: #dc3545; 
    }
    .btn-reject:hover { 
      background: #c9303c; 
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .muted { 
      text-align: center; 
      color: #777; 
      margin-top: 20px; 
      padding: 20px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateX(150%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    .notification.success {
      background: #28a745;
    }
    .notification.error {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <h1>Ù„ÙˆØ­Ø© Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h1>
  <div id="status">â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Webhook...</div>
  <div id="counter">Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <span id="count">0</span></div>
  <div id="grid" class="grid"></div>
  <div id="empty" class="muted">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // === Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ===
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f"
    };
    
    // ØªÙ‡ÙŠØ¦Ø© Firebase
    try {
      firebase.initializeApp(firebaseConfig);
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
    }
    
    const db = firebase.firestore();

    // Ø¹Ù†Ø§ØµØ± DOM
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const countEl = document.getElementById('count');
    const statusEl = document.getElementById('status');

    // === Ø±Ø§Ø¨Ø· Webhook (API) ===
    const WEBHOOK_URL = "https://hematech.xyz/api/notify";

    // === Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // === ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Webhook ===
    async function checkWebhook() {
      try {
        statusEl.textContent = "â³ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Webhook...";
        statusEl.className = "warning";
        
        const res = await fetch(WEBHOOK_URL, {
          method: 'GET',
          headers: { 
            'Cache-Control': 'no-cache',
            'Content-Type': 'application/json'
          }
        });

        if (res.ok) {
          const data = await res.json().catch(() => ({}));
          statusEl.textContent = data.message || "âœ… Ø§Ù„Ù€ Webhook Ø´ØºÙ‘Ø§Ù„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ";
          statusEl.className = "ok";
        } else {
          const text = await res.text();
          console.error("Webhook Error Response:", text);
          statusEl.textContent = `âš ï¸ Ø§Ù„Ù€ Webhook Ù„Ø§ ÙŠØ³ØªØ¬ÙŠØ¨ (${res.status})`;
          statusEl.className = "error";
        }
      } catch (err) {
        console.error("Webhook Connection Failed:", err);
        statusEl.textContent = "âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ WebhookØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø£Ùˆ Ø§Ù„Ù€ CORS";
        statusEl.className = "error";
      }
    }

    // === ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® ===
    function formatDate(timestamp) {
      if (!timestamp) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      
      let date;
      if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else {
        date = new Date(timestamp);
      }
      
      return date.toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // === ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³ ===
    db.collection('subscriptions')
      .where('status', '==', 'pending')
      .orderBy('createdAt', 'desc')
      .onSnapshot(snapshot => {
        grid.innerHTML = "";
        countEl.innerText = snapshot.size;
        
        if (snapshot.empty) {
          empty.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© âœ…";
          return;
        }
        
        empty.innerText = "";
        
        snapshot.forEach(doc => {
          const d = doc.data();
          const card = document.createElement('div');
          card.className = 'card';
          card.innerHTML = `
            <div class="card-header">
              <span class="card-id">ID: ${doc.id.substring(0, 8)}</span>
              <span class="card-date">${formatDate(d.createdAt)}</span>
            </div>
            <img src="${d.proofUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" 
                 alt="Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ" 
                 onerror="this.src='https://via.placeholder.com/300x200?text=Ø®Ø·Ø£+ÙÙŠ+Ø§Ù„ØµÙˆØ±Ø©'">
            <div class="info">
              <strong>${d.name || "Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</strong>
              <code>${d.telegramId || 'Ø¨Ø¯ÙˆÙ† ID'}</code>
            </div>
            <div class="btns">
              <button class="btn btn-accept" data-id="${doc.id}">
                <span class="btn-text">âœ… Ù‚Ø¨ÙˆÙ„</span>
              </button>
              <button class="btn btn-reject" data-id="${doc.id}">
                <span class="btn-text">âŒ Ø±ÙØ¶</span>
              </button>
            </div>
          `;

          // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
          card.querySelector('.btn-accept').addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const originalText = button.querySelector('.btn-text').textContent;
            button.querySelector('.btn-text').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù‚Ø¨ÙˆÙ„...';
            button.disabled = true;
            
            try {
              await db.collection('subscriptions').doc(doc.id).update({ 
                status: 'approved',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              await sendNotification(d.telegramId, 'âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø¥Ø«Ø¨Ø§Øª Ø§Ø´ØªØ±Ø§ÙƒÙƒ! Ø´ÙƒØ±Ù‹Ø§ Ù„Ùƒ ğŸŒŸ');
              showNotification('ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
            } catch (error) {
              console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨:', error);
              showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø·Ù„Ø¨', 'error');
            } finally {
              button.querySelector('.btn-text').textContent = originalText;
              button.disabled = false;
            }
          });

          card.querySelector('.btn-reject').addEventListener('click', async (e) => {
            const button = e.currentTarget;
            const originalText = button.querySelector('.btn-text').textContent;
            button.querySelector('.btn-text').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¶...';
            button.disabled = true;
            
            try {
              await db.collection('subscriptions').doc(doc.id).update({ 
                status: 'rejected',
                reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              
              await sendNotification(d.telegramId, 'âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¥Ø«Ø¨Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø¶Ø­Ø© ÙˆØ¬Ø¯ÙŠØ¯Ø© ÙˆØ­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
              showNotification('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
            } catch (error) {
              console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨:', error);
              showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨', 'error');
            } finally {
              button.querySelector('.btn-text').textContent = originalText;
              button.disabled = false;
            }
          });

          grid.appendChild(card);
        });
      }, error => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        empty.innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.";
      });

    // === Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø¨Ø± Webhook ===
    async function sendNotification(telegramId, message) {
      if (!telegramId) {
        console.warn('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù ØªÙ„ØºØ±Ø§Ù… Ù„Ù„Ø¥Ø±Ø³Ø§Ù„');
        return;
      }
      
      try {
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            telegramId: telegramId.toString(), 
            message 
          })
        });
        
        if (!res.ok) {
          const errText = await res.text();
          console.error('âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', errText);
          throw new Error(`ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ${res.status}`);
        } else {
          console.log('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­');
          return true;
        }
      } catch (err) {
        console.error('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:', err);
        throw err;
      }
    }

    // ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù€ Webhook Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
    document.addEventListener('DOMContentLoaded', () => {
      checkWebhook();
      // ÙØ­Øµ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 15 Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ù…Ù„
      setInterval(checkWebhook, 30000);
    });
  </script>
</body>
</html>
