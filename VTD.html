
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة مراجعة الطلبات</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary:#007bff;--success:#28a745;--danger:#dc3545;--warning:#ffc107;
      --light:#f8f9fa;--dark:#343a40;--gray:#6c757d;
      --border-radius:12px;--box-shadow:0 3px 10px rgba(0,0,0,0.08);
      --transition:all 0.3s ease;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#f5f6fa;font-family:"Cairo",sans-serif;padding:20px;color:#222}
    .container{max-width:1200px;margin:0 auto}
    header{text-align:center;margin-bottom:30px;padding:15px;background:white;border-radius:var(--border-radius);box-shadow:var(--box-shadow)}
    h1{margin-bottom:10px;color:var(--dark);font-weight:700}
    .subtitle{color:var(--gray)}
    .status-container{display:flex;justify-content:center;margin-bottom:25px}
    #status{text-align:center;font-weight:600;padding:12px 20px;border-radius:var(--border-radius);width:100%;max-width:500px;display:flex;align-items:center;justify-content:center;gap:10px}
    .ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .warning{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
    .stats{display:flex;justify-content:center;gap:20px;margin-bottom:30px;flex-wrap:wrap}
    .stat-card{background:white;padding:20px;border-radius:var(--border-radius);box-shadow:var(--box-shadow);text-align:center;min-width:180px}
    .stat-value{font-size:2rem;font-weight:700;color:var(--primary);margin-bottom:5px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:25px;margin-bottom:30px}
    .card{background:#fff;border-radius:var(--border-radius);box-shadow:var(--box-shadow);padding:20px;display:flex;flex-direction:column;transition:var(--transition)}
    .card:hover{transform:translateY(-5px);box-shadow:0 8px 20px rgba(0,0,0,0.15)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee}
    .card-title{font-weight:600;color:var(--dark)}
    .card-date{font-size:.8rem;color:var(--gray)}
    .card-image{width:100%;height:200px;border-radius:8px;margin-bottom:15px;object-fit:cover;cursor:pointer;transition:var(--transition)}
    .card-image:hover{opacity:.9}
    .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:white;font-weight:600}
    .card-actions{display:flex;justify-content:center;gap:10px;margin-top:auto}
    .btn{border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:600;color:#fff;font-size:14px;transition:var(--transition);display:flex;align-items:center;gap:5px;flex:1;justify-content:center}
    .btn-accept{background:var(--success)}
    .btn-accept:hover:not(:disabled){background:#23923c}
    .btn-reject{background:var(--danger)}
    .btn-reject:hover:not(:disabled){background:#c9303c}
    .loading{display:flex;justify-content:center;align-items:center;padding:40px}
    .spinner{width:40px;height:40px;border:4px solid rgba(0,123,255,0.2);border-left:4px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;justify-content:center;align-items:center}
    .modal-content{max-width:90%;max-height:90%;border-radius:10px;overflow:hidden;box-shadow:0 5px 25px rgba(0,0,0,0.3)}
    .modal-close{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.5);color:white;border:none;width:40px;height:40px;border-radius:50%;font-size:1.5rem;cursor:pointer}
    .toast{position:fixed;bottom:20px;right:20px;padding:15px 20px;border-radius:var(--border-radius);color:white;font-weight:600;box-shadow:0 4px 12px rgba(0,0,0,0.15);z-index:1001;transform:translateY(100px);opacity:0;transition:all 0.3s ease}
    .toast.show{transform:translateY(0);opacity:1}
    .toast.success{background:var(--success)}
    .toast.error{background:var(--danger)}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>لوحة مراجعة الطلبات</h1>
      <p class="subtitle">مراجعة وإدارة طلبات الاشتراك المعلقة</p>
    </header>

    <div class="status-container">
      <div id="status">
        <span class="spinner" style="width:20px;height:20px"></span>
        جاري فحص حالة الـ Webhook...
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="count">0</div>
        <div>الطلبات قيد المراجعة</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="processed">0</div>
        <div>تمت معالجتها</div>
      </div>
    </div>

    <div id="grid" class="grid"></div>

    <div id="empty" style="display:none;text-align:center;color:gray;padding:40px">
      📋 لا توجد طلبات حالياً
    </div>

    <div id="loading" class="loading"><div class="spinner"></div></div>
  </div>

  <div id="imageModal" class="modal">
    <button class="modal-close">&times;</button>
    <div class="modal-content">
      <img id="modalImage" src="" style="width:100%;height:auto">
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey:"AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain:"hhhhhh-d4fb8.firebaseapp.com",
      projectId:"hhhhhh-d4fb8",
      storageBucket:"hhhhhh-d4fb8.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const grid=document.getElementById("grid"),
          empty=document.getElementById("empty"),
          loading=document.getElementById("loading"),
          countEl=document.getElementById("count"),
          processedEl=document.getElementById("processed"),
          statusEl=document.getElementById("status"),
          toast=document.getElementById("toast"),
          modal=document.getElementById("imageModal"),
          modalImg=document.getElementById("modalImage"),
          modalClose=document.querySelector(".modal-close");

    const WEBHOOK_URL="https://www.hematech.xyz/api/notify"; // ✅ تأكد أنه موجود في Vercel

    let processedCount=0;

    async function checkWebhook(){
      try{
        const res=await fetch(WEBHOOK_URL,{method:"OPTIONS"});
        if(res.ok){
          statusEl.innerHTML="✅ الـ Webhook يعمل بشكل طبيعي";
          statusEl.className="ok";
        }else{
          statusEl.innerHTML="⚠️ الـ Webhook لا يستجيب";
          statusEl.className="warning";
        }
      }catch{
        statusEl.innerHTML="❌ فشل الاتصال بالـ Webhook (CORS أو السيرفر)";
        statusEl.className="error";
      }
    }

    function showToast(msg,type="success"){
      toast.textContent=msg;
      toast.className=`toast ${type} show`;
      setTimeout(()=>toast.classList.remove("show"),3000);
    }

    function openModal(src){modal.style.display="flex";modalImg.src=src;}
    function closeModal(){modal.style.display="none";modalImg.src="";}

    modalClose.onclick=closeModal;
    modal.onclick=e=>{if(e.target===modal)closeModal()};

    db.collection("subscriptions").where("status","==","pending").orderBy("createdAt","desc")
    .onSnapshot(snapshot=>{
      loading.style.display="none";
      grid.innerHTML="";
      countEl.textContent=snapshot.size;
      if(snapshot.empty){empty.style.display="block";return}
      empty.style.display="none";
      snapshot.forEach(doc=>{
        const d=doc.data();
        const date=d.createdAt?d.createdAt.toDate():new Date();
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <div class="card-header">
            <div class="card-title">طلب اشتراك</div>
            <div class="card-date">${date.toLocaleDateString('ar-EG')}</div>
          </div>
          <img class="card-image" src="${d.proofUrl}" alt="دليل" />
          <div style="margin:10px 0">
            <div><strong>${d.name||"مستخدم"}</strong></div>
            <div style="font-size:13px;color:gray">${d.telegramId}</div>
          </div>
          <div class="card-actions">
            <button class="btn btn-accept">✅ قبول</button>
            <button class="btn btn-reject">❌ رفض</button>
          </div>`;
        card.querySelector(".card-image").onclick=()=>openModal(d.proofUrl);

        const acceptBtn=card.querySelector(".btn-accept");
        const rejectBtn=card.querySelector(".btn-reject");

        acceptBtn.onclick=async()=>{
          acceptBtn.disabled=rejectBtn.disabled=true;
          acceptBtn.innerHTML="⏳ جاري...";
          try{
            await db.collection("subscriptions").doc(doc.id).update({
              status:"approved",
              reviewedAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            processedEl.textContent=++processedCount;
            showToast("تم قبول الطلب");
            sendNotification(d.telegramId,`✅ تم قبول إثبات اشتراكك! شكرًا لك 🌟\n📲 يمكنك الآن الاستمتاع بمميزات البوت ⭐`);
          }catch(e){
            showToast("خطأ في القبول","error");
            acceptBtn.disabled=rejectBtn.disabled=false;
          }
        };

        rejectBtn.onclick=async()=>{
          rejectBtn.disabled=acceptBtn.disabled=true;
          rejectBtn.innerHTML="⏳ جاري...";
          try{
            await db.collection("subscriptions").doc(doc.id).update({
              status:"rejected",
              reviewedAt:firebase.firestore.FieldValue.serverTimestamp()
            });
            processedEl.textContent=++processedCount;
            showToast("تم رفض الطلب");
            sendNotification(d.telegramId,`❌ تم رفض إثبات الاشتراك.\n📸 تأكد أن الصورة واضحة وأرسل من جديد.`);
          }catch(e){
            showToast("خطأ في الرفض","error");
            rejectBtn.disabled=acceptBtn.disabled=false;
          }
        };

        grid.appendChild(card);
      });
    });

    async function sendNotification(telegramId,message){
      try{
        const res=await fetch(WEBHOOK_URL,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({telegramId,message})
        });
        if(!res.ok)showToast("تم القبول ولكن الإشعار فشل","error");
      }catch{
        showToast("خطأ أثناء إرسال الإشعار","error");
      }
    }

    document.addEventListener("DOMContentLoaded",()=>{
      checkWebhook();
      setInterval(checkWebhook,15000);
    });
  </script>
</body>
</html>
